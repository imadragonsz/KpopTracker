<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>K-Pop Album Tracker</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../styles/global.css" />
    <link rel="stylesheet" href="../styles/navbar.css" />
    <link rel="stylesheet" href="../styles/album-cards.css" />
    <link rel="stylesheet" href="../styles/modals.css" />
    <link rel="stylesheet" href="../styles/forms.css" />
    <link rel="stylesheet" href="../styles/loading.css" />
  </head>
  <body class="profile-bg">
    <div id="navbar-include"></div>
    <script>
      // Only load and inject the navbar if not already present
      if (!document.getElementById("navbar-include").dataset.loaded) {
        fetch("./components/navbar.html")
          .then((res) => res.text())
          .then((html) => {
            const navbarDiv = document.getElementById("navbar-include");
            navbarDiv.innerHTML = html;
            navbarDiv.dataset.loaded = "true";
            // Execute all scripts in the injected navbar
            const scripts = navbarDiv.querySelectorAll("script");
            scripts.forEach((oldScript) => {
              const newScript = document.createElement("script");
              if (oldScript.type) newScript.type = oldScript.type;
              if (oldScript.src) {
                newScript.src = oldScript.src;
              } else {
                newScript.textContent = oldScript.textContent;
              }
              document.body.appendChild(newScript);
            });
            setTimeout(() => {
              const toggler = document.querySelector(".navbar-toggler");
              const collapse = document.getElementById("navbarNav");
              if (window.bootstrap && toggler && collapse) {
                new window.bootstrap.Collapse(collapse, { toggle: false });
              }
            }, 0);
            if (!window._navbarScriptsLoaded) {
              window._navbarScriptsLoaded = true;
              const supabaseScript = document.createElement("script");
              supabaseScript.src =
                "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js";
              supabaseScript.onload = () => {
                const scripts = [
                  "../js/components/loading.js",
                  "../js/authUI.js",
                  "../js/api/supabaseClient.js",
                  "../js/api/groupApi.js",
                  "../js/api/albumApi.js",
                ];
                scripts.forEach((src) => {
                  const s = document.createElement("script");
                  s.type = "module";
                  s.src = src;
                  document.body.appendChild(s);
                });
                // Wait for updateAuthUIReady before calling updateAuthUI or running dependent code
                window.addEventListener(
                  "updateAuthUIReady",
                  () => {
                    if (window.updateAuthUI) window.updateAuthUI();
                  },
                  { once: true }
                );
              };
              document.body.appendChild(supabaseScript);
            }
          });
      }
    </script>

    <div class="main-content">
      <section
        class="py-5 text-center"
        style="background: linear-gradient(180deg, #232946 45%, #181a20 80%)"
      >
        <div class="container">
          <img
            src="https://cdn-icons-png.flaticon.com/512/727/727245.png"
            alt="K-Pop Vinyl"
            style="
              width: 100px;
              height: 100px;
              background: #232a36;
              border-radius: 50%;
              padding: 12px;
              border: 2px solid #43c6ac;
            "
            class="mb-3 mt-2 shadow-none"
          />
          <h1 class="fw-bold mb-2 hero-heading-text text-center">
            Your K-Pop Album Library
          </h1>
          <p class="lead mb-4 hero-lead-text text-center">
            Add, browse, and celebrate every album in your K-Pop journey. This
            is your digital shelf—make it shine!
          </p>
          <a
            href="/pages/albumCollection.html"
            class="btn btn-info btn-lg px-5 fw-bold"
            id="goToAlbumCollectionBtn"
            >Go to Album Collection</a
          >
          <script>
            // Intercept click to set a flag for login modal
            document
              .getElementById("goToAlbumCollectionBtn")
              .addEventListener("click", function (e) {
                sessionStorage.setItem("showLoginOnAlbumPage", "1");
              });
          </script>
        </div>
      </section>

      <section class="container p-4 rounded shadow-lg">
        <div class="row g-4 justify-content-center">
          <div class="col-md-4">
            <div class="card h-100 border-info">
              <div class="card-body">
                <h5 class="card-title" style="color: #67e8f9">
                  Album Collection
                </h5>
                <p class="card-text">
                  Add, edit, and browse your K-Pop albums. See your collection
                  grow with every comeback!
                </p>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card h-100 border-info">
              <div class="card-body">
                <h5 class="card-title" style="color: #67e8f9">
                  Group & Member Management
                </h5>
                <p class="card-text">
                  Track your favorite groups and members, celebrate birthdays
                  and milestones, and keep your K-Pop universe organized!
                </p>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card h-100 border-info">
              <div class="card-body">
                <h5 class="card-title" style="color: #67e8f9">
                  Private & Portable
                </h5>
                <p class="card-text">
                  Your collection, your rules. Log in to keep your albums safe
                  and access them anywhere—no more lost lists or spreadsheets.
                </p>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="container py-4">
        <div class="row align-items-center">
          <div class="col-md-7 mb-3 mb-md-0">
            <h3 class="fw-bold" style="color: #43c6ac">
              Why use K-Pop Album Tracker?
            </h3>
            <ul class="list-unstyled mb-2" style="color: #eaeaea">
              <li>• No more lost sticky notes or endless spreadsheets</li>
              <li>• See your collection stats at a glance</li>
              <li>• Designed for fans, by a fan—no ads, no paywall</li>
              <li>• Suggest features or report bugs anytime</li>
            </ul>
            <p class="mb-0" style="color: #bfc9db">
              This project is a labor of love for the K-Pop community. Your
              feedback and ideas are always welcome!
            </p>
          </div>
          <div class="col-md-5 text-center">
            <img
              src="https://cdn-icons-png.flaticon.com/512/727/727245.png"
              alt="Vinyl Icon"
              class="img-fluid rounded border border-info"
              style="max-width: 120px; background: #232a36; padding: 16px"
            />
          </div>
        </div>
      </section>
    </div>

    <footer
      class="text-center py-4 mt-5"
      style="
        color: #bfc9db;
        background: #232226;
        border-radius: 0 0 18px 18px;
        box-shadow: 0 -2px 16px 0 #a06c8533;
      "
    >
      <div class="container">
        <small>
          K-Pop Album Tracker &copy; 2025. Made with
          <span style="color: #ff6f61">♥</span> for the K-Pop community. |
          <a href="#" style="color: #a06c85">Privacy Policy</a> |
          <a href="#" style="color: #a06c85">Terms</a>
        </small>
      </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module" src="../js/components/loading.js"></script>
    <script type="module" src="../js/authUI.js"></script>
    <script>
      // After navbar is injected, bind userMenuBtn logic
      function setupUserMenuBtnListener() {
        var btn = document.getElementById("userMenuBtn");
        if (!btn) return;
        btn.addEventListener("click", function () {
          console.log("userMenuBtn pressed");
          var ModalClass =
            window.bootstrap && window.bootstrap.Modal
              ? window.bootstrap.Modal
              : window.Modal || null;
          if (!ModalClass) {
            console.warn("Bootstrap Modal not found.");
            return;
          }
          var modalElem = document.getElementById("userMenuModal");
          if (!modalElem) {
            console.warn("userMenuModal element not found.");
            return;
          }
          function showModal(isLoggedIn, email) {
            var body = document.getElementById("userMenuModalBody");
            if (!body) return;
            if (isLoggedIn) {
              body.innerHTML = `
                <div class=\"mb-3 text-center\">
                  <i class=\"bi bi-person-circle\" style=\"font-size:2.5em;\"></i>
                  <div class=\"fw-bold mt-2\">${email}</div>
                </div>
                <div class=\"d-grid gap-2\">
                  <a href=\"/pages/profile.html\" class=\"btn btn-info\">My Profile</a>
                  <button id=\"logoutBtnModal\" class=\"btn btn-outline-secondary\">Logout</button>
                </div>
              `;
              setTimeout(function () {
                var logoutBtn = document.getElementById("logoutBtnModal");
                if (logoutBtn) {
                  logoutBtn.onclick = function () {
                    if (window.signOut) {
                      window.signOut();
                    } else if (window.supabase) {
                      window.supabase.auth.signOut().then(function () {
                        window.location.reload();
                      });
                    } else {
                      window.location.reload();
                    }
                  };
                }
              }, 0);
            } else {
              body.innerHTML = `
                <div class=\"mb-3 text-center\">
                  <i class=\"bi bi-person-circle\" style=\"font-size:2.5em;\"></i>
                </div>
                <div class=\"d-grid gap-2\">
                  <button id=\"loginBtnModal\" class=\"btn btn-info\">Login</button>
                </div>
              `;
              setTimeout(function () {
                var loginBtn = document.getElementById("loginBtnModal");
                if (loginBtn) {
                  loginBtn.onclick = function () {
                    if (typeof showLoginModal === "function") {
                      showLoginModal();
                    } else {
                      var modal = document.getElementById("authModal");
                      if (modal && window.bootstrap) {
                        var modalInstance = new window.bootstrap.Modal(modal);
                        modalInstance.show();
                      }
                    }
                  };
                }
              }, 0);
            }
            var modal = new ModalClass(modalElem);
            modal.show();
          }
          // Always use Supabase as the source of truth for auth state
          if (
            window.supabase &&
            window.supabase.auth &&
            window.supabase.auth.getUser
          ) {
            window.supabase.auth.getUser().then(function (resp) {
              var user = resp && resp.data && resp.data.user;
              if (user && user.email) {
                showModal(true, user.email);
              } else {
                showModal(false, "");
              }
            });
          } else {
            showModal(false, "");
          }
        });
      }
      // Wait for navbar to be injected, then bind
      function tryBindUserMenuBtn(retries) {
        if (document.getElementById("userMenuBtn")) {
          setupUserMenuBtnListener();
        } else if (retries > 0) {
          setTimeout(function () {
            tryBindUserMenuBtn(retries - 1);
          }, 200);
        }
      }
      tryBindUserMenuBtn(20);
    </script>
  </body>
</html>
