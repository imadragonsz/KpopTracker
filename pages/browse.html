<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Browse K-Pop Albums & Groups</title>
    <link
      rel="preload"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      as="style"
      onload="this.rel='stylesheet'"
    />
    <noscript
      ><link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    /></noscript>
    <link
      rel="preload"
      href="../styles/gallery.bundle.min.css"
      as="style"
      onload="this.rel='stylesheet'"
    />
    <noscript
      ><link rel="stylesheet" href="../styles/gallery.bundle.min.css"
    /></noscript>
  </head>
  <body class="profile-bg">
    <div id="navbar-include"></div>
    <script>
      (async function loadNavbarAndScripts() {
        const navbarDiv = document.getElementById("navbar-include");
        if (navbarDiv.dataset.loaded) return;

        // Fetch and inject navbar HTML
        const html = await fetch("./components/navbar.html").then((res) =>
          res.text()
        );
        navbarDiv.innerHTML = html;
        navbarDiv.dataset.loaded = "true";
        // Dynamically load navbar.js after injection
        const script = document.createElement("script");
        script.type = "module";
        script.src = "../js/navbar.js";
        document.body.appendChild(script);
        // (Reverted) No manual toggler/collapse re-binding; use default Bootstrap behavior as before.

        // Load Supabase and Bootstrap if not already loaded
        const loadScript = (src, type = "text/javascript") =>
          new Promise((resolve, reject) => {
            if ([...document.scripts].some((s) => s.src.includes(src)))
              return resolve();
            const s = document.createElement("script");
            s.src = src;
            s.type = type;
            s.onload = resolve;
            s.onerror = reject;
            document.body.appendChild(s);
          });

        await loadScript(
          "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"
        );
        await loadScript(
          "https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        );

        // Load your app scripts (as modules if needed)
        const appScripts = [
          "../js/components/loading.js",
          "../js/authUI.js",
          "../js/api/supabaseClient.js",
          "../js/api/groupApi.js",
          "../js/api/albumApi.js",
        ];
        for (const src of appScripts) {
          await loadScript(src, "module");
        }

        // Wait for updateAuthUIReady before running dependent code
        window.addEventListener(
          "updateAuthUIReady",
          () => {
            if (typeof window.updateAuthUI === "function")
              window.updateAuthUI();
          },
          { once: true }
        );
      })();
    </script>
    <div
      class="container mt-4 fade-in"
      style="padding-top: 50px; max-width: none; width: 100%"
    >
      <h2 class="mb-4 text-center">Browse All Groups & Albums</h2>
      <div class="row mb-3 justify-content-center">
        <div class="col-12 col-md-6 d-flex justify-content-center mb-2">
          <input
            type="text"
            id="browseSearchInput"
            class="form-control w-100 mb-2 rounded-3 px-3 py-2"
            style="max-width: 90%; min-width: 0; font-size: 1.1em"
            placeholder="Search groups or albums..."
          />
        </div>
      </div>
      <div id="browseResults"></div>
    </div>
    <!-- Album Info Modal Include -->
    <div id="album-info-modal-include"></div>
    <script
      src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"
      defer
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
      defer
    ></script>
    <script type="module" src="../js/pages/browsePage.js"></script>
    <script type="module" src="../js/authUI.js"></script>
    <script>
      // Inject navbar
      fetch("./components/navbar.html")
        .then((res) => res.text())
        .then((html) => {
          document.getElementById("navbar-include").innerHTML = html;
        });
      // Inject album info modal
      fetch("./components/albumInfoModal.html")
        .then((res) => res.text())
        .then((html) => {
          document.getElementById("album-info-modal-include").innerHTML = html;
        });
      // After navbar is injected, bind userMenuBtn logic
      function setupUserMenuBtnListener() {
        var btn = document.getElementById("userMenuBtn");
        if (!btn) return;
        btn.addEventListener("click", function () {
          console.log("userMenuBtn pressed");
          var ModalClass =
            window.bootstrap && window.bootstrap.Modal
              ? window.bootstrap.Modal
              : window.Modal || null;
          if (!ModalClass) {
            console.warn("Bootstrap Modal not found.");
            return;
          }
          var modalElem = document.getElementById("userMenuModal");
          if (!modalElem) {
            console.warn("userMenuModal element not found.");
            return;
          }
          function showModal(isLoggedIn, email) {
            var body = document.getElementById("userMenuModalBody");
            if (!body) return;
            if (isLoggedIn) {
              body.innerHTML = `
                <div class=\"mb-3 text-center\">
                  <i class=\"bi bi-person-circle\" style=\"font-size:2.5em;\"></i>
                  <div class=\"fw-bold mt-2\">${email}</div>
                </div>
                <div class=\"d-grid gap-2\">
                  <a href=\"/pages/profile.html\" class=\"btn btn-info\">My Profile</a>
                  <button id=\"logoutBtnModal\" class=\"btn btn-outline-secondary\">Logout</button>
                </div>
              `;
              setTimeout(function () {
                var logoutBtn = document.getElementById("logoutBtnModal");
                if (logoutBtn) {
                  logoutBtn.onclick = function () {
                    if (window.signOut) {
                      window.signOut();
                    } else if (window.supabase) {
                      window.supabase.auth.signOut().then(function () {
                        window.location.reload();
                      });
                    } else {
                      window.location.reload();
                    }
                  };
                }
              }, 0);
            } else {
              body.innerHTML = `
                <div class=\"mb-3 text-center\">
                  <i class=\"bi bi-person-circle\" style=\"font-size:2.5em;\"></i>
                </div>
                <div class=\"d-grid gap-2\">
                  <button id=\"loginBtnModal\" class=\"btn btn-info\">Login</button>
                </div>
              `;
              setTimeout(function () {
                var loginBtn = document.getElementById("loginBtnModal");
                if (loginBtn) {
                  loginBtn.onclick = function () {
                    if (typeof showLoginModal === "function") {
                      showLoginModal();
                    } else {
                      var modal = document.getElementById("authModal");
                      if (modal && window.bootstrap) {
                        var modalInstance = new window.bootstrap.Modal(modal);
                        modalInstance.show();
                      }
                    }
                  };
                }
              }, 0);
            }
            var modal = new ModalClass(modalElem);
            modal.show();
          }
          // Always use Supabase as the source of truth for auth state
          if (
            window.supabase &&
            window.supabase.auth &&
            window.supabase.auth.getUser
          ) {
            window.supabase.auth.getUser().then(function (resp) {
              var user = resp && resp.data && resp.data.user;
              if (user && user.email) {
                showModal(true, user.email);
              } else {
                showModal(false, "");
              }
            });
          } else {
            showModal(false, "");
          }
        });
      }
      // Wait for navbar to be injected, then bind
      function tryBindUserMenuBtn(retries) {
        if (document.getElementById("userMenuBtn")) {
          setupUserMenuBtnListener();
        } else if (retries > 0) {
          setTimeout(function () {
            tryBindUserMenuBtn(retries - 1);
          }, 200);
        }
      }
      tryBindUserMenuBtn(20);
    </script>
  </body>
  <script>
    // Dynamically load userMenuModal.js after supabaseClient.js is ready
    (function loadUserMenuModalWhenReady() {
      function injectScript() {
        const script = document.createElement("script");
        script.type = "module";
        script.src = "../js/userMenuModal.js";
        document.body.appendChild(script);
      }
      if (window.supabasePromise) {
        injectScript();
      } else {
        let tries = 0;
        const maxTries = 20;
        const interval = setInterval(() => {
          if (window.supabasePromise) {
            clearInterval(interval);
            injectScript();
          } else if (++tries >= maxTries) {
            clearInterval(interval);
            console.error(
              "userMenuModal.js: supabasePromise not found after waiting."
            );
          }
        }, 100);
      }
    })();
  </script>
  <script src="../js/edgeColorBackground.js"></script>
</html>
