<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Profile | K-Pop Album Tracker</title>
    <link
      rel="preload"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      as="style"
      onload="this.rel='stylesheet'"
    />
    <noscript
      ><link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    /></noscript>
    <link
      rel="preload"
      href="../styles/gallery.bundle.min.css"
      as="style"
      onload="this.rel='stylesheet'"
    />
    <noscript
      ><link rel="stylesheet" href="../styles/gallery.bundle.min.css"
    /></noscript>
    <link
      rel="preload"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
      as="style"
      onload="this.rel='stylesheet'"
    />
    <noscript
      ><link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    /></noscript>
    <link
      rel="preload"
      href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"
      as="style"
      onload="this.rel='stylesheet'"
    />
    <noscript
      ><link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"
    /></noscript>
    <style id="choices-dark-theme">
      .choices.choices-dark,
      .choices.choices-dark .choices__inner,
      .choices.choices-dark .choices__list--dropdown,
      .choices.choices-dark .choices__list[aria-expanded] {
        background: #181a20 !important;
        color: #e0e0e0 !important;
        border-color: #43c6ac !important;
      }
      .choices.choices-dark .choices__item--selectable,
      .choices.choices-dark .choices__item {
        color: #e0e0e0 !important;
        background: #181a20 !important;
      }
      .choices.choices-dark .choices__item--selectable.is-highlighted,
      .choices.choices-dark .choices__item--selectable.is-selected {
        background: #23272f !important;
        color: #43c6ac !important;
      }
      .choices.choices-dark .choices__input {
        background: #181a20 !important;
        color: #e0e0e0 !important;
      }
      .choices.choices-dark .choices__placeholder {
        color: #43c6ac !important;
        opacity: 1 !important;
      }
      .choices.choices-dark
        .choices__list--dropdown
        .choices__item--selectable {
        border-bottom: 1px solid #23272f !important;
      }
      .choices.choices-dark .choices__list--dropdown {
        box-shadow: 0 4px 24px #43c6ac33 !important;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js"></script>
  </head>
  <body
    class="profile-bg"
    style="
      font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(180deg, #232946 10%, #181a20 20%);
      color: #eaeaea;
      margin: 0;
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    "
  >
    <div id="navbar-include"></div>
    <script>
      (async function loadNavbarAndScripts() {
        const navbarDiv = document.getElementById("navbar-include");
        if (navbarDiv.dataset.loaded) return;
        // Fetch and inject navbar HTML
        const html = await fetch("./components/navbar.html").then((res) =>
          res.text()
        );
        navbarDiv.innerHTML = html;
        navbarDiv.dataset.loaded = "true";
        // Dynamically load navbar.js after injection
        const script = document.createElement("script");
        script.type = "module";
        script.src = "../js/navbar.js";
        document.body.appendChild(script);
        // (Reverted) No manual toggler/collapse re-binding; use default Bootstrap behavior as before.
        // Load Supabase and Bootstrap if not already loaded
        const loadScript = (src, type = "text/javascript") =>
          new Promise((resolve, reject) => {
            if ([...document.scripts].some((s) => s.src.includes(src)))
              return resolve();
            const s = document.createElement("script");
            s.src = src;
            s.type = type;
            s.onload = resolve;
            s.onerror = reject;
            document.body.appendChild(s);
          });
        await loadScript(
          "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js",
          "text/javascript",
          true // defer
        );
        await loadScript(
          "https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js",
          "text/javascript",
          true // defer
        );
        // Load your app scripts (as modules if needed)
        const appScripts = [
          "../js/components/loading.js",
          "../js/authUI.js",
          "../js/api/supabaseClient.js",
          "../js/api/groupApi.js",
          "../js/api/albumApi.js",
          "../js/pages/profilePage.js",
        ];
        for (const src of appScripts) {
          await loadScript(src, "module");
        }
        // Wait for updateAuthUIReady before running dependent code
        window.addEventListener(
          "updateAuthUIReady",
          () => {
            if (typeof window.updateAuthUI === "function")
              window.updateAuthUI();
            // After all scripts, check for login modal flag
            setTimeout(() => {
              if (sessionStorage.getItem("showLoginOnProfilePage")) {
                sessionStorage.removeItem("showLoginOnProfilePage");
                setTimeout(() => {
                  const loginBtn = document.getElementById("loginBtn");
                  const logoutBtn = document.getElementById("logoutBtn");
                  if (
                    loginBtn &&
                    (!logoutBtn || logoutBtn.classList.contains("d-none"))
                  ) {
                    loginBtn.click();
                  }
                }, 500);
              }
            }, 1000);
          },
          { once: true }
        );
      })();
    </script>
    <!-- ...existing code... -->
    <!-- Album Versions On The Way will be rendered here by profilePage.js -->

    <!-- Album Info Modal (for albumModals.js) -->
    <div
      class="modal fade"
      id="albumInfoModal"
      tabindex="-1"
      aria-labelledby="albumInfoModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-light">
          <div class="modal-header">
            <h5 class="modal-title" id="albumInfoModalLabel">Album Info</h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body" id="albumInfoBody">
            <!-- Album info will be injected here by JS -->
          </div>
        </div>
      </div>
    </div>

    <!-- Change Password Modal -->
    <div
      class="modal fade"
      id="changePasswordModal"
      tabindex="-1"
      aria-labelledby="changePasswordModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
          <div class="modal-header">
            <h5 class="modal-title" id="changePasswordModalLabel">
              Change Password
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <form id="changePasswordForm" autocomplete="off">
            <div class="modal-body">
              <div class="mb-3">
                <label for="oldPassword" class="form-label"
                  >Current Password</label
                >
                <input
                  type="password"
                  class="form-control"
                  id="oldPassword"
                  name="oldPassword"
                  minlength="6"
                  required
                  autocomplete="current-password"
                />
              </div>
              <div class="mb-3">
                <label for="newPassword" class="form-label">New Password</label>
                <input
                  type="password"
                  class="form-control"
                  id="newPassword"
                  name="newPassword"
                  minlength="6"
                  required
                  autocomplete="new-password"
                />
              </div>
              <div class="mb-3">
                <label for="confirmPassword" class="form-label"
                  >Confirm New Password</label
                >
                <input
                  type="password"
                  class="form-control"
                  id="confirmPassword"
                  name="confirmPassword"
                  minlength="6"
                  required
                  autocomplete="new-password"
                />
              </div>
              <div
                id="changePasswordFeedback"
                class="form-text text-danger"
              ></div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Cancel
              </button>
              <button type="submit" class="btn btn-info">
                Change Password
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Main Profile Container -->
    <div
      class="container p-4 rounded shadow-lg"
      style="
        max-width: 900px;
        background: rgba(35, 41, 70, 0.98);
        width: 100%;
        border-radius: 24px;
        border: 1.5px solid #43c6ac;
        margin-top: 90px;
      "
    >
      <!-- Profile Header -->
      <div class="row g-3 mb-4 align-items-center">
        <div class="col-12 text-center mb-2">
          <h1
            class="fw-bold mb-2 hero-heading-text"
            style="letter-spacing: 1px"
          >
            <span style="vertical-align: middle; color: #43c6ac"
              ><i class="bi bi-person-circle"></i
            ></span>
            My Profile
          </h1>
        </div>
        <div class="col-12 col-md-3 text-center">
          <img
            src="https://cdn-icons-png.flaticon.com/512/727/727245.png"
            alt="User Icon"
            id="profile-picture"
            style="
              width: 120px;
              height: 120px;
              background: #232a36;
              border-radius: 50%;
              padding: 10px;
              border: 3px solid #43c6ac;
              box-shadow: 0 4px 24px 0 #43c6ac44;
              object-fit: cover;
            "
            class="mb-3 mt-2 shadow"
          />
        </div>
        <div class="col-12 col-md-9">
          <div class="row g-2">
            <div class="col-6 col-lg-4">
              <div class="card text-center border-info bg-dark h-100 card-pop">
                <div class="card-body py-3">
                  <div class="fw-bold text-info mb-1">Email</div>
                  <div id="user-email" class="fs-6"></div>
                </div>
              </div>
            </div>
            <div class="col-6 col-lg-4">
              <div class="card text-center border-info bg-dark h-100 card-pop">
                <div class="card-body py-3">
                  <div class="fw-bold text-info mb-1">Joined</div>
                  <div id="user-joined" class="fs-6"></div>
                </div>
              </div>
            </div>
            <div class="col-6 col-lg-4">
              <div class="card text-center border-info bg-dark h-100 card-pop">
                <div class="card-body py-3">
                  <div class="fw-bold text-info mb-1">Display Name</div>
                  <div class="mb-2">
                    <input
                      type="text"
                      id="user-display-name-input"
                      class="form-control form-control-sm bg-dark text-info border-info"
                      placeholder="Enter display name"
                      maxlength="32"
                      autocomplete="off"
                    />
                  </div>
                  <div class="mb-2">
                    <button
                      id="save-display-name-btn"
                      class="btn btn-info btn-sm w-100 animated-btn"
                    >
                      Save
                    </button>
                  </div>
                  <div
                    id="user-display-name-status"
                    class="form-text text-success"
                  ></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <hr class="my-4" style="border-color: #43c6ac; opacity: 0.3" />

      <!-- Collection Stats -->
      <div class="row g-3 mb-4">
        <div class="col-12 mb-2">
          <h4 class="fw-bold text-info mb-3">
            <i class="bi bi-bar-chart-fill me-2"></i>Collection Stats
          </h4>
        </div>
        <div class="col-6 col-lg-3">
          <div class="card text-center border-info bg-dark h-100">
            <div class="card-body py-3">
              <div class="fw-bold text-info mb-1">Albums</div>
              <div id="user-album-count" class="fs-6"></div>
            </div>
          </div>
        </div>
        <div class="col-6 col-lg-3">
          <div class="card text-center border-info bg-dark h-100">
            <div class="card-body py-3">
              <div class="fw-bold text-info mb-1">Versions</div>
              <div id="user-version-count" class="fs-6"></div>
            </div>
          </div>
        </div>
        <div class="col-6 col-lg-3">
          <div class="card text-center border-info bg-dark h-100">
            <div class="card-body py-3">
              <div class="fw-bold text-info mb-1">Groups</div>
              <div id="user-group-count" class="fs-6"></div>
            </div>
          </div>
        </div>
        <div class="col-6 col-lg-3">
          <div class="card text-center border-info bg-dark h-100">
            <div class="card-body py-3">
              <div class="fw-bold text-info mb-1">On the Way</div>
              <div id="user-ontheway-count" class="fs-6"></div>
            </div>
          </div>
        </div>
      </div>

      <hr class="my-4" style="border-color: #43c6ac; opacity: 0.3" />

      <!-- Highlights -->
      <div class="row g-3 mb-4">
        <div class="col-12 mb-2">
          <h4 class="fw-bold text-info mb-3">
            <i class="bi bi-trophy-fill me-2"></i>Highlights
          </h4>
        </div>
        <div class="col-12 col-lg-6">
          <div class="card border-info bg-dark h-100">
            <div class="card-body text-center">
              <div class="fw-bold text-info mb-1">Most Collected Group</div>
              <div id="user-most-collected-group" class="fs-6"></div>
            </div>
          </div>
        </div>
        <div class="col-12 col-lg-6">
          <div class="card border-info bg-dark h-100">
            <div class="card-body text-center">
              <div class="fw-bold text-info mb-1">Achievements</div>
              <div id="user-achievements" class="fs-6 text-secondary">
                (coming soon)
              </div>
            </div>
          </div>
        </div>
      </div>

      <hr class="my-4" style="border-color: #43c6ac; opacity: 0.3" />

      <!-- Recent Activity -->
      <div class="row g-3 mb-4">
        <div class="col-12 mb-2">
          <h4 class="fw-bold text-info mb-3">
            <i class="bi bi-clock-history me-2"></i>Recent Activity
          </h4>
        </div>
        <div class="col-12 col-lg-6">
          <div class="card border-info bg-dark h-100">
            <div class="card-body">
              <h5 class="text-info mb-2">Recently Added Albums</h5>
              <ul id="profile-recent-albums" class="list-group small"></ul>
            </div>
          </div>
        </div>
        <div class="col-12 col-lg-6">
          <div class="card border-info bg-dark h-100">
            <div class="card-body">
              <h5 class="text-info mb-2">Recently Updated Albums</h5>
              <ul id="profile-recent-updated" class="list-group small"></ul>
            </div>
          </div>
        </div>
        <div id="onTheWaySectionPlaceholder"></div>
      </div>

      <hr class="my-4" style="border-color: #43c6ac; opacity: 0.3" />

      <!-- Export / Import & Gallery Management -->
      <div class="row g-3 mb-4">
        <div class="col-12 mb-2">
          <h4 class="fw-bold text-info mb-3">
            <i class="bi bi-arrow-down-up me-2"></i>Export / Import
          </h4>
        </div>
        <div class="col-12">
          <div class="card border-info bg-dark h-100">
            <div class="card-body text-center">
              <h5 class="text-info mb-2">Export / Import</h5>
              <button
                class="btn btn-outline-info btn-sm mb-2"
                id="export-csv-btn"
              >
                Export as CSV
              </button>
              <button
                class="btn btn-outline-info btn-sm mb-2"
                id="export-json-btn"
              >
                Export as JSON
              </button>
              <input
                type="file"
                id="import-file-input"
                class="form-control form-control-sm mt-2"
                accept=".json,.csv"
              />
              <div id="import-result" class="mt-3 text-start"></div>
              <hr class="my-4" style="border-color: #43c6ac; opacity: 0.3" />
              <h5 class="text-info mb-2">Gallery Management</h5>
              <button
                class="btn btn-outline-warning btn-sm mb-2"
                id="open-gallery-management-btn"
                type="button"
              >
                <i class="bi bi-images me-1"></i>Manage Gallery Images
              </button>
              <div class="form-text text-secondary mb-2">
                Add or remove images used in the gallery modal.
              </div>
            </div>
          </div>
        </div>
      </div>
      <!--
        The gallery management modal uses <input list="..."> with a <datalist> for group selection.
        This is the best-practice, accessible way to allow both dropdown selection (from existing groups)
        and free custom entry (for new groups) in modern browsers. No further customization is needed unless
        you want a fully custom dropdown UI. See js/components/galleryModal.js for implementation details.
      -->
      <script type="module">
        // Gallery Management Button Handler
        document.addEventListener("DOMContentLoaded", () => {
          const btn = document.getElementById("open-gallery-management-btn");
          if (btn) {
            btn.addEventListener("click", async () => {
              // Dynamically import and show the gallery management modal
              const { showGalleryManagementModal } = await import(
                "../js/components/galleryModal.js"
              );
              showGalleryManagementModal({
                title: "Manage Gallery Images",
              });
            });
          }
        });
      </script>

      <hr class="my-4" style="border-color: #43c6ac; opacity: 0.3" />

      <!-- Account Management & Feedback -->
      <div class="row g-3 mb-4">
        <div class="col-12 col-lg-6">
          <div class="card border-info bg-dark h-100">
            <div class="card-body text-center">
              <h5 class="text-info mb-2">
                <i class="bi bi-person-gear me-2"></i>Account Management
              </h5>
              <button
                class="btn btn-outline-warning btn-sm mb-2"
                id="change-password-btn"
                data-bs-toggle="modal"
                data-bs-target="#changePasswordModal"
                style="transition: box-shadow 0.2s"
                onmouseover="this.style.boxShadow='0 0 0 2px #43c6ac55';"
                onmouseout="this.style.boxShadow='none';"
              >
                <i class="bi bi-key me-1"></i>Change Password
              </button>
              <button
                class="btn btn-outline-secondary btn-sm mb-2"
                id="logoutBtnProfile"
                style="transition: box-shadow 0.2s"
                onmouseover="this.style.boxShadow='0 0 0 2px #43c6ac55';"
                onmouseout="this.style.boxShadow='none';"
              >
                <i class="bi bi-box-arrow-right me-1"></i>Log Out
              </button>
            </div>
          </div>
        </div>
        <div class="col-12 col-lg-6">
          <div class="card border-info bg-dark h-100">
            <div class="card-body text-center">
              <h5 class="text-info mb-2">
                <i class="bi bi-chat-dots me-2"></i>Feedback & Support
              </h5>
              <a
                href="mailto:support@kpoptracker.com"
                class="btn btn-outline-info btn-sm mb-2"
                style="transition: box-shadow 0.2s"
                onmouseover="this.style.boxShadow='0 0 0 2px #43c6ac55';"
                onmouseout="this.style.boxShadow='none';"
                ><i class="bi bi-envelope me-1"></i>Contact Support</a
              >
              <a
                href="https://github.com/imadragonsz/KpopTracker/issues"
                target="_blank"
                class="btn btn-outline-info btn-sm mb-2"
                style="transition: box-shadow 0.2s"
                onmouseover="this.style.boxShadow='0 0 0 2px #43c6ac55';"
                onmouseout="this.style.boxShadow='none';"
                ><i class="bi bi-github me-1"></i>Submit Feedback</a
              >
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer
      class="text-center py-4 mt-5"
      style="
        color: #bfc9db;
        background: #232226;
        border-radius: 0 0 18px 18px;
        box-shadow: 0 -2px 16px 0 #a06c8533;
      "
    >
      <div class="container">
        <small>
          K-Pop Album Tracker &copy; 2025. Made with
          <span style="color: #ff6f61">♥</span> for the K-Pop community. |
          <a href="#" style="color: #a06c85">Privacy Policy</a> |
          <a href="#" style="color: #a06c85">Terms</a>
        </small>
      </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module" src="../js/authUI.js"></script>
    <script type="module" src="../js/pages/profilePage.js"></script>
    <script>
      // After navbar is injected, bind userMenuBtn logic
      function setupUserMenuBtnListener() {
        var btn = document.getElementById("userMenuBtn");
        if (!btn) return;
        btn.addEventListener("click", function () {
          var ModalClass =
            window.bootstrap && window.bootstrap.Modal
              ? window.bootstrap.Modal
              : window.Modal || null;
          if (!ModalClass) return;
          var modalElem = document.getElementById("userMenuModal");
          if (!modalElem) return;
          function showModal(isLoggedIn, email) {
            var body = document.getElementById("userMenuModalBody");
            if (!body) return;
            if (isLoggedIn) {
              body.innerHTML = `
                <div class="mb-3 text-center">
                  <i class="bi bi-person-circle" style="font-size:2.5em;"></i>
                  <div class="fw-bold mt-2">${email}</div>
                </div>
                <div class="d-grid gap-2">
                  <a href="/pages/profile.html" class="btn btn-info">My Profile</a>
                  <button id="logoutBtnModal" class="btn btn-outline-secondary">Logout</button>
                </div>
              `;
              setTimeout(function () {
                var logoutBtn = document.getElementById("logoutBtnModal");
                if (logoutBtn) {
                  logoutBtn.onclick = function () {
                    if (window.signOut) {
                      window.signOut();
                    } else if (window.supabase) {
                      window.supabase.auth.signOut().then(function () {
                        window.location.reload();
                      });
                    } else {
                      window.location.reload();
                    }
                  };
                }
              }, 0);
            } else {
              body.innerHTML = `
                <div class="mb-3 text-center">
                  <i class="bi bi-person-circle" style="font-size:2.5em;"></i>
                </div>
                <div class="d-grid gap-2">
                  <button id="loginBtnModal" class="btn btn-info">Login</button>
                </div>
              `;
              setTimeout(function () {
                var loginBtn = document.getElementById("loginBtnModal");
                if (loginBtn) {
                  loginBtn.onclick = function () {
                    if (typeof showLoginModal === "function") {
                      showLoginModal();
                    } else {
                      var modal = document.getElementById("authModal");
                      if (modal && window.bootstrap) {
                        var modalInstance = new window.bootstrap.Modal(modal);
                        modalInstance.show();
                      }
                    }
                  };
                }
              }, 0);
            }
            var modal = new ModalClass(modalElem);
            modal.show();
          }
          // Always use Supabase as the source of truth for auth state
          if (
            window.supabase &&
            window.supabase.auth &&
            window.supabase.auth.getUser
          ) {
            window.supabase.auth.getUser().then(function (resp) {
              var user = resp && resp.data && resp.data.user;
              if (user && user.email) {
                showModal(true, user.email);
              } else {
                showModal(false, "");
              }
            });
          } else {
            showModal(false, "");
          }
        });
      }
      // Wait for navbar to be injected, then bind
      function tryBindUserMenuBtn(retries) {
        if (document.getElementById("userMenuBtn")) {
          setupUserMenuBtnListener();
        } else if (retries > 0) {
          setTimeout(function () {
            tryBindUserMenuBtn(retries - 1);
          }, 200);
        }
      }
      tryBindUserMenuBtn(20);
    </script>
    <script>
      // Dynamically load userMenuModal.js after supabaseClient.js is ready
      (function loadUserMenuModalWhenReady() {
        function injectScript() {
          const script = document.createElement("script");
          script.type = "module";
          script.src = "../js/userMenuModal.js";
          document.body.appendChild(script);
        }
        if (window.supabasePromise) {
          injectScript();
        } else {
          let tries = 0;
          const maxTries = 20;
          const interval = setInterval(() => {
            if (window.supabasePromise) {
              clearInterval(interval);
              injectScript();
            } else if (++tries >= maxTries) {
              clearInterval(interval);
              console.error(
                "userMenuModal.js: supabasePromise not found after waiting."
              );
            }
          }, 100);
        }
      })();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  </body>
</html>
