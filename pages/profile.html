<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Profile | K-Pop Album Tracker</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  <link rel="stylesheet" href="../styles/global.css" />
  <link rel="stylesheet" href="../styles/navbar.css" />
  <link rel="stylesheet" href="../styles/album-cards.css" />
  <link rel="stylesheet" href="../styles/modals.css" />
  <link rel="stylesheet" href="../styles/forms.css" />
  <link rel="stylesheet" href="../styles/loading.css" />
  <body class="profile-bg" style="font-family: 'Inter', 'Segoe UI', Arial, sans-serif; background: linear-gradient(180deg, #232946 10%, #181a20 20%); color: #eaeaea; margin: 0; min-height: 100vh; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;">
    
    <div id="navbar-include"></div>
    <script>
      // Only load and inject the navbar if not already present
      if (!document.getElementById('navbar-include').dataset.loaded) {
        fetch('./components/navbar.html')
          .then(res => res.text())
          .then(html => {
            document.getElementById('navbar-include').innerHTML = html;
            document.getElementById('navbar-include').dataset.loaded = 'true';
            // Re-initialize Bootstrap Collapse for navbar toggler to fix lag
            setTimeout(() => {
              const toggler = document.querySelector('.navbar-toggler');
              const collapse = document.getElementById('navbarNav');
              if (window.bootstrap && toggler && collapse) {
                new window.bootstrap.Collapse(collapse, { toggle: false });
              }
            }, 0);
            // Only load scripts once
            if (!window._navbarScriptsLoaded) {
              window._navbarScriptsLoaded = true;
              const supabaseScript = document.createElement('script');
              supabaseScript.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js';
              supabaseScript.onload = () => {
                const scripts = [
                  '../js/components/loading.js',
                  '../js/authUI.js',
                  '../js/api/supabaseClient.js',
                  '../js/api/groupApi.js',
                  '../js/api/albumApi.js',
                  '../js/pages/profilePage.js'
                ];
                scripts.forEach(src => {
                  const s = document.createElement('script');
                  s.type = 'module';
                  s.src = src;
                  document.body.appendChild(s);
                });
                // After all scripts, check for login modal flag
                setTimeout(() => {
                  if (sessionStorage.getItem('showLoginOnProfilePage')) {
                    sessionStorage.removeItem('showLoginOnProfilePage');
                    setTimeout(() => {
                      const loginBtn = document.getElementById('loginBtn');
                      const logoutBtn = document.getElementById('logoutBtn');
                      if (loginBtn && (!logoutBtn || logoutBtn.classList.contains('d-none'))) {
                        loginBtn.click();
                      }
                    }, 500);
                  }
                }, 1000);
              };
              document.body.appendChild(supabaseScript);
            }
          });
      }
    </script>

    
    <div
      class="modal fade"
      id="changePasswordModal"
      tabindex="-1"
      aria-labelledby="changePasswordModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
          <div class="modal-header">
            <h5 class="modal-title" id="changePasswordModalLabel">
              Change Password
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <form id="changePasswordForm" autocomplete="off">
            <div class="modal-body">
              <div class="mb-3">
                <label for="oldPassword" class="form-label"
                  >Current Password</label
                >
                <input
                  type="password"
                  class="form-control"
                  id="oldPassword"
                  name="oldPassword"
                  minlength="6"
                  required
                  autocomplete="current-password"
                />
              </div>
              <div class="mb-3">
                <label for="newPassword" class="form-label">New Password</label>
                <input
                  type="password"
                  class="form-control"
                  id="newPassword"
                  name="newPassword"
                  minlength="6"
                  required
                  autocomplete="new-password"
                />
              </div>
              <div class="mb-3">
                <label for="confirmPassword" class="form-label"
                  >Confirm New Password</label
                >
                <input
                  type="password"
                  class="form-control"
                  id="confirmPassword"
                  name="confirmPassword"
                  minlength="6"
                  required
                  autocomplete="new-password"
                />
              </div>
              <div
                id="changePasswordFeedback"
                class="form-text text-danger"
              ></div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Cancel
              </button>
              <button type="submit" class="btn btn-info">
                Change Password
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <div
      class="container p-4 rounded shadow-lg"
      style="
        max-width: 900px;
        background: rgba(35, 41, 70, 0.98);
        width: 100%;
        border-radius: 24px;
        border: 1.5px solid #43c6ac;
        margin-top: 90px;
      "
    >
      
      <div class="row g-3 mb-4 align-items-center">
        <div class="col-12 text-center mb-2">
          <h1
            class="fw-bold mb-2 hero-heading-text"
            style="letter-spacing: 1px"
          >
            <span style="vertical-align: middle; color: #43c6ac">
              <i class="bi bi-person-circle"></i>
            </span>
            My Profile
          </h1>
        </div>
        <div class="col-12 col-md-3 text-center">
          <img
            src="https://cdn-icons-png.flaticon.com/512/727/727245.png"
            alt="User Icon"
            id="profile-picture"
            style="
              width: 120px;
              height: 120px;
              background: #232a36;
              border-radius: 50%;
              padding: 10px;
              border: 3px solid #43c6ac;
              box-shadow: 0 4px 24px 0 #43c6ac44;
              object-fit: cover;
            "
            class="mb-3 mt-2 shadow"
          />
        </div>
        <div class="col-12 col-md-9">
          <div class="row g-2">
            <div class="col-6 col-lg-4">
              <div class="card text-center border-info bg-dark h-100">
                <div class="card-body py-3">
                  <div class="fw-bold text-info mb-1">Email</div>
                  <div id="user-email" class="fs-6"></div>
                </div>
              </div>
            </div>
            <div class="col-6 col-lg-4">
              <div class="card text-center border-info bg-dark h-100">
                <div class="card-body py-3">
                  <div class="fw-bold text-info mb-1">Joined</div>
                  <div id="user-joined" class="fs-6"></div>
                </div>
              </div>
            </div>
            <div class="col-6 col-lg-4">
              <div class="card text-center border-info bg-dark h-100">
                <div class="card-body py-3">
                  <div class="fw-bold text-info mb-1">Display Name</div>
                  <div class="mb-2">
                    <input
                      type="text"
                      id="user-display-name-input"
                      class="form-control form-control-sm bg-dark text-info border-info"
                      placeholder="Enter display name"
                      maxlength="32"
                      autocomplete="off"
                    />
                  </div>
                  <div class="mb-2">
                    <button
                      id="save-display-name-btn"
                      class="btn btn-info btn-sm w-100"
                    >
                      Save
                    </button>
                  </div>
                  <div
                    id="user-display-name-status"
                    class="form-text text-success"
                  ></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <hr class="my-4" style="border-color: #43c6ac; opacity: 0.3" />
      
      <div class="row g-3 mb-4">
        <div class="col-12 mb-2">
          <h4 class="fw-bold text-info mb-3">
            <i class="bi bi-bar-chart-fill me-2"></i>Collection Stats
          </h4>
        </div>
        <div class="col-6 col-lg-3">
          <div class="card text-center border-info bg-dark h-100">
            <div class="card-body py-3">
              <div class="fw-bold text-info mb-1">Albums</div>
              <div id="user-album-count" class="fs-6"></div>
            </div>
          </div>
        </div>
        <div class="col-6 col-lg-3">
          <div class="card text-center border-info bg-dark h-100">
            <div class="card-body py-3">
              <div class="fw-bold text-info mb-1">Versions</div>
              <div id="user-version-count" class="fs-6"></div>
            </div>
          </div>
        </div>
        <div class="col-6 col-lg-3">
          <div class="card text-center border-info bg-dark h-100">
            <div class="card-body py-3">
              <div class="fw-bold text-info mb-1">Groups</div>
              <div id="user-group-count" class="fs-6"></div>
            </div>
          </div>
        </div>
        <div class="col-6 col-lg-3">
          <div class="card text-center border-info bg-dark h-100">
            <div class="card-body py-3">
              <div class="fw-bold text-info mb-1">On the Way</div>
              <div id="user-ontheway-count" class="fs-6"></div>
            </div>
          </div>
        </div>
      </div>

      <hr class="my-4" style="border-color: #43c6ac; opacity: 0.3" />
      
      <div class="row g-3 mb-4">
        <div class="col-12 mb-2">
          <h4 class="fw-bold text-info mb-3">
            <i class="bi bi-trophy-fill me-2"></i>Highlights
          </h4>
        </div>
        <div class="col-12 col-lg-6">
          <div class="card border-info bg-dark h-100">
            <div class="card-body text-center">
              <div class="fw-bold text-info mb-1">Most Collected Group</div>
              <div id="user-most-collected-group" class="fs-6"></div>
            </div>
          </div>
        </div>
        <div class="col-12 col-lg-6">
          <div class="card border-info bg-dark h-100">
            <div class="card-body text-center">
              <div class="fw-bold text-info mb-1">Achievements</div>
              <div id="user-achievements" class="fs-6 text-secondary">
                (coming soon)
              </div>
            </div>
          </div>
        </div>
      </div>

      <hr class="my-4" style="border-color: #43c6ac; opacity: 0.3" />
      
      <div class="row g-3 mb-4">
        <div class="col-12 mb-2">
          <h4 class="fw-bold text-info mb-3">
            <i class="bi bi-clock-history me-2"></i>Recent Activity
          </h4>
        </div>
        <div class="col-12 col-lg-6">
          <div class="card border-info bg-dark h-100">
            <div class="card-body">
              <h5 class="text-info mb-2">Recently Added Albums</h5>
              <ul id="profile-recent-albums" class="list-group small"></ul>
            </div>
          </div>
        </div>
        <div class="col-12 col-lg-6">
          <div class="card border-info bg-dark h-100">
            <div class="card-body">
              <h5 class="text-info mb-2">Recently Updated Albums</h5>
              <ul id="profile-recent-updated" class="list-group small"></ul>
            </div>
          </div>
        </div>
      </div>

      <hr class="my-4" style="border-color: #43c6ac; opacity: 0.3" />
      
      <div class="row g-3 mb-4">
        <div class="col-12 mb-2">
          <h4 class="fw-bold text-info mb-3">
            <i class="bi bi-arrow-down-up me-2"></i>Export / Import
          </h4>
        </div>
        <div class="col-12">
          <div class="card border-info bg-dark h-100">
            <div class="card-body text-center">
              <h5 class="text-info mb-2">Export / Import</h5>
              <button
                class="btn btn-outline-info btn-sm mb-2"
                id="export-csv-btn"
              >
                Export as CSV
              </button>
              <button
                class="btn btn-outline-info btn-sm mb-2"
                id="export-json-btn"
              >
                Export as JSON
              </button>
              <input
                type="file"
                id="import-file-input"
                class="form-control form-control-sm mt-2"
                accept=".json,.csv"
              />
              <div id="import-result" class="mt-3 text-start"></div>
            </div>
          </div>
        </div>
      </div>

      <hr class="my-4" style="border-color: #43c6ac; opacity: 0.3" />
      
      <div class="row g-3 mb-4">
        <div class="col-12 col-lg-6">
          <div class="card border-info bg-dark h-100">
            <div class="card-body text-center">
              <h5 class="text-info mb-2">
                <i class="bi bi-person-gear me-2"></i>Account Management
              </h5>
              <button
                class="btn btn-outline-warning btn-sm mb-2"
                id="change-password-btn"
                data-bs-toggle="modal"
                data-bs-target="#changePasswordModal"
                style="transition: box-shadow 0.2s"
                onmouseover="this.style.boxShadow='0 0 0 2px #43c6ac55';"
                onmouseout="this.style.boxShadow='none';"
              >
                <i class="bi bi-key me-1"></i>Change Password
              </button>
              <button
                class="btn btn-outline-secondary btn-sm mb-2"
                id="logoutBtnProfile"
                style="transition: box-shadow 0.2s"
                onmouseover="this.style.boxShadow='0 0 0 2px #43c6ac55';"
                onmouseout="this.style.boxShadow='none';"
              >
                <i class="bi bi-box-arrow-right me-1"></i>Log Out
              </button>
            </div>
          </div>
        </div>
        <div class="col-12 col-lg-6">
          <div class="card border-info bg-dark h-100">
            <div class="card-body text-center">
              <h5 class="text-info mb-2">
                <i class="bi bi-chat-dots me-2"></i>Feedback & Support
              </h5>
              <a
                href="mailto:support@kpoptracker.com"
                class="btn btn-outline-info btn-sm mb-2"
                style="transition: box-shadow 0.2s"
                onmouseover="this.style.boxShadow='0 0 0 2px #43c6ac55';"
                onmouseout="this.style.boxShadow='none';"
                ><i class="bi bi-envelope me-1"></i>Contact Support</a
              >
              <a
                href="https://github.com/imadragonsz/KpopTracker/issues"
                target="_blank"
                class="btn btn-outline-info btn-sm mb-2"
                style="transition: box-shadow 0.2s"
                onmouseover="this.style.boxShadow='0 0 0 2px #43c6ac55';"
                onmouseout="this.style.boxShadow='none';"
                ><i class="bi bi-github me-1"></i>Submit Feedback</a
              >
            </div>
          </div>
        </div>
      </div>
    </div>
    <footer
      class="text-center py-4 mt-5"
      style="
        color: #bfc9db;
        background: #232226;
        border-radius: 0 0 18px 18px;
        box-shadow: 0 -2px 16px 0 #a06c8533;
      "
    >
      <div class="container">
        <small>
          K-Pop Album Tracker &copy; 2025. Made with
          <span style="color: #ff6f61">♥</span> for the K-Pop community. |
          <a href="#" style="color: #a06c85">Privacy Policy</a> |
          <a href="#" style="color: #a06c85">Terms</a>
        </small>
      </div>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <script type="module" src="../js/authUI.js"></script>
    <script type="module" src="../js/pages/profilePage.js"></script>
  </body>
</html>
