  <script type="module" src="../js/pages/groupManagement.js"></script>
<!DOCTYPE html>
<html lang="en">
  <head>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
    />
    <style>
      .hero-section h1,
      .hero-section p {
        word-break: break-word;
        overflow-wrap: break-word;
        hyphens: auto;
      }
      @media (min-width: 768px) {
        .hero-section p {
          max-width: 600px;
          margin-left: auto;
          margin-right: auto;
        }
      }
    </style>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Group & Member Management</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  <link rel="stylesheet" href="../styles/global.css" />
  <link rel="stylesheet" href="../styles/navbar.css" />
  <link rel="stylesheet" href="../styles/album-cards.css" />
  <link rel="stylesheet" href="../styles/modals.css" />
  <link rel="stylesheet" href="../styles/forms.css" />
  <link rel="stylesheet" href="../styles/loading.css" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </head>
  <body class="profile-bg">
    <div id="navbar-include"></div>
    <script>
      // Only load and inject the navbar if not already present
      if (!document.getElementById("navbar-include").dataset.loaded) {
        fetch("./components/navbar.html")
          .then((res) => res.text())
          .then((html) => {
            document.getElementById("navbar-include").innerHTML = html;
            document.getElementById("navbar-include").dataset.loaded = "true";
            // Re-initialize Bootstrap Collapse for navbar toggler to fix lag
            setTimeout(() => {
              const toggler = document.querySelector(".navbar-toggler");
              const collapse = document.getElementById("navbarNav");
              if (window.bootstrap && toggler && collapse) {
                new window.bootstrap.Collapse(collapse, { toggle: false });
              }
            }, 0);
            // Only load scripts once
            if (!window._navbarScriptsLoaded) {
              window._navbarScriptsLoaded = true;
              const supabaseScript = document.createElement("script");
              supabaseScript.src =
                "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js";
              supabaseScript.onload = () => {
                const scripts = [
                  "../js/components/loading.js",
                  "../js/authUI.js",
                  "../js/api/supabaseClient.js",
                  "../js/api/groupApi.js",
                  "../js/api/albumApi.js"
                ];
                scripts.forEach((src) => {
                  const s = document.createElement("script");
                  s.type = "module";
                  s.src = src;
                  document.body.appendChild(s);
                });
                // After all scripts, check for login modal flag
                setTimeout(() => {
                  if (sessionStorage.getItem("showLoginOnGroupPage")) {
                    sessionStorage.removeItem("showLoginOnGroupPage");
                    setTimeout(() => {
                      const loginBtn = document.getElementById("loginBtn");
                      const logoutBtn = document.getElementById("logoutBtn");
                      if (
                        loginBtn &&
                        (!logoutBtn || logoutBtn.classList.contains("d-none"))
                      ) {
                        loginBtn.click();
                      }
                    }, 500);
                  }
                }, 1000);
              };
              document.body.appendChild(supabaseScript);
            }
          });
      }
    </script>

    <section class="py-5 text-center hero-section">
      <div class="container">
        <img
          src="https://cdn-icons-png.flaticon.com/512/727/727245.png"
          alt="Vinyl Icon"
          style="
            width: 90px;
            height: 90px;
            background: #232a36;
            border-radius: 50%;
            padding: 10px;
            border: 2px solid #43c6ac;
          "
          class="mb-3 mt-2 shadow-none"
        />
        <h1 class="fw-bold mb-2 hero-heading-text text-center">
  <script type="module" src="../js/pages/groupsPage.js"></script>
          Group & Member Management
        </h1>
        <p class="lead mb-3 hero-lead-text text-center">
          Track your favorite groups and members, celebrate birthdays and
          milestones, and keep your K-Pop universe organized!
        </p>
      </div>
    </section>
    <div
      class="container p-4 rounded shadow-lg main-container"
      style="
        margin-top: 20px;
        max-width: 700px;
        background: #232946;
        width: 100%;
      "
    >
      <div class="row g-3 mb-3 align-items-end">
        <div class="col-12 col-md-6">
          <input
            type="text"
            id="searchGroupInput"
            class="form-control"
            placeholder="Search by group name..."
          />
        </div>
        <div class="col-12 col-md-6 d-flex align-items-center gap-2">
          <select
            id="groupSortSelect"
            class="form-select flex-grow-1"
            style="max-width: 70%"
          >
            <option value="az">Sort: Group A-Z</option>
            <option value="za">Sort: Group Z-A</option>
          </select>
          <span
            id="groupCount"
            class="group-count-badge ms-2"
            style="white-space: nowrap"
            ><i class="bi bi-people-fill me-1"></i
          ></span>
        </div>
      </div>

      <div class="row g-3 mb-4">
        <div class="col-12">
          <div class="card border-info bg-dark">
            <div class="card-body">
              <form id="addGroupForm" class="row g-2 align-items-end">
                <div class="col-12 col-md-8">
                  <input
                    type="text"
                    id="groupName"
                    class="form-control"
                    placeholder="Group Name (e.g. BTS)"
                    required
                  />
                </div>
                <div class="col-12 col-md-4">
                  <!-- Removed groupImageFile input, now handled by modal gallery -->
                  <div class="mb-2">
                    <button
                      type="button"
                      class="btn btn-outline-info btn-sm"
                      id="showGroupImageModal"
                    >
                      Choose Existing Image
                    </button>
                  </div>
                  <input type="hidden" id="groupImage" />
                  <div
                    id="groupImageUploadStatus"
                    class="form-text text-info"
                  ></div>
                </div>
                <div class="col-12">
                  <textarea
                    id="groupNotes"
                    class="form-control"
                    rows="2"
                    placeholder="Notes, fun facts, or your own group ranking..."
                  ></textarea>
                </div>
                <div class="col-12 d-grid mt-2">
                  <button
                    type="submit"
                    class="btn btn-info fw-bold add-group-btn-mb"
                  >
                    Add Group
                  </button>
                </div>
              </form>
              <ul id="groupList" class="list-group mb-3"></ul>
            </div>
          </div>
        </div>
      </div>

      <div
        id="galleryView"
        class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4"
      ></div>
    </div>
    <footer
      class="text-center py-4 mt-5"
      style="
        color: #bfc9db;
        background: #232226;
        border-radius: 0 0 18px 18px;
        box-shadow: 0 -2px 16px 0 #a06c8533;
      "
    >
      <div class="container">
        <small>
          K-Pop Album Tracker &copy; 2025. Made with
          <span style="color: #ff6f61">â™¥</span> for the K-Pop community. |
          <a href="#" style="color: #a06c85">Privacy Policy</a> |
          <a href="#" style="color: #a06c85">Terms</a>
        </small>
      </div>
    </footer>

    <div
      class="modal fade"
      id="editGroupModal"
      tabindex="-1"
      aria-labelledby="editGroupModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
          <div class="modal-header">
            <h5 class="modal-title" id="editGroupModalLabel">Edit Group</h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="editGroupForm">
              <div class="mb-3">
                <label for="editGroupName" class="form-label">Group Name</label>
                <input
                  type="text"
                  class="form-control"
                  id="editGroupName"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="editGroupImage" class="form-label"
                  >Group Image URL</label
                >
                <!-- Removed editGroupImageFile input, now handled by modal gallery -->
                <div class="mb-2">
                  <button
                    type="button"
                    class="btn btn-outline-info btn-sm"
                    id="showEditGroupImageModal"
                  >
                    Choose Existing Image
                  </button>
                </div>
                <input type="hidden" id="editGroupImage" />
                <div
                  id="editGroupImageUploadStatus"
                  class="form-text text-info"
                ></div>
                <script type="module">
                  import { showGalleryModal } from '../js/components/galleryModal.js';
                  document.addEventListener("DOMContentLoaded", function () {
                    const groupBtn = document.getElementById("showGroupImageModal");
                    const groupInput = document.getElementById("groupImage");
                    const groupNameInput = document.getElementById("groupName");
                    if (groupBtn && groupInput) {
                      groupBtn.onclick = null;
                      groupBtn.onclick = function () {
                        showGalleryModal({
                          onSelect: async (url) => {
                            groupInput.value = url;
                            if (window.editingGroupId) {
                              const name = document.getElementById('editGroupName').value.trim();
                              const notes = document.getElementById('editGroupNotes').value.trim();
                              await window.updateGroup(window.editingGroupId, name, url, notes);
                            }
                          },
                          title: "Select or Upload Group Image",
                          groupName: groupNameInput && groupNameInput.value ? groupNameInput.value : null
                        });
                      };
                    }
                    const editBtn = document.getElementById("showEditGroupImageModal");
                    const editInput = document.getElementById("editGroupImage");
                    const editGroupNameInput = document.getElementById("editGroupName");
                    if (editBtn && editInput) {
                      editBtn.onclick = null;
                      editBtn.onclick = function () {
                        showGalleryModal({
                          onSelect: async (url) => {
                            editInput.value = url;
                            if (window.editingGroupId) {
                              const name = document.getElementById('editGroupName').value.trim();
                              const notes = document.getElementById('editGroupNotes').value.trim();
                              await window.updateGroup(window.editingGroupId, name, url, notes);
                            }
                          },
                          title: "Select or Upload Group Image",
                          groupName: editGroupNameInput && editGroupNameInput.value ? editGroupNameInput.value : null
                        });
                      };
                    }
                  });
                </script>
              </div>
              <div class="mb-3">
                <label for="editGroupNotes" class="form-label"
                  >Notes/Comments</label
                >
                <textarea
                  class="form-control"
                  id="editGroupNotes"
                  rows="2"
                  placeholder="Notes/Comments for this group..."
                ></textarea>
              </div>
              <button type="submit" class="btn btn-info fw-bold">
                Save Changes
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div
      class="modal fade"
      id="groupInfoModal"
      tabindex="-1"
      aria-labelledby="groupInfoModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
          <div class="modal-header">
            <h5 class="modal-title" id="groupInfoModalLabel">Group Info</h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body" id="groupInfoBody"></div>
        </div>
      </div>
    </div>

    <div
      class="modal fade"
      id="manageMembersModal"
      tabindex="-1"
      aria-labelledby="manageMembersModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
          <div class="modal-header">
            <h5 class="modal-title" id="manageMembersModalLabel">
              Manage Members
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="addMemberForm" class="mb-3">
              <input
                type="text"
                class="form-control mb-2"
                id="memberName"
                placeholder="Member Name"
                required
              />
              <input
                    type="file"
                    id="groupImageFile"
                    class="form-control mb-1"
                    accept="image/*"
                    style="display:none;"
                  />
                  <div class="mb-2">
                    <button type="button" class="btn btn-outline-info btn-sm" id="openGroupGalleryModal">Choose or Upload Image</button>
                  </div>
                  <input type="hidden" id="groupImage" />
                  <div id="groupImageUploadStatus" class="form-text text-info"></div>
              />
              <input
                type="text"
                class="form-control mb-2"
                id="memberInfo"
                placeholder="Info (optional)"
              />
              <input
                  type="file"
                  class="form-control mb-1"
                  id="editGroupImageFile"
                  accept="image/*"
                  style="display:none;"
                />
                <div class="mb-2">
                  <button type="button" class="btn btn-outline-info btn-sm" id="openEditGroupGalleryModal">Choose or Upload Image</button>
                </div>
                <input type="hidden" id="editGroupImage" />
                <div id="editGroupImageUploadStatus" class="form-text text-info"></div>
    </div>

    <div
      class="modal fade"
      id="memberInfoModal"
      tabindex="-1"
      aria-labelledby="memberInfoModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
          <div class="modal-header">
            <h5 class="modal-title" id="memberInfoModalLabel">Member Info</h5>
            <button
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body" id="memberInfoBody"></div>
        </div>
      </div>
    </div>

    <div
      class="modal fade"
      id="albumInfoModal"
      tabindex="-1"
      aria-labelledby="albumInfoModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
          <div class="modal-header">
            <h5 class="modal-title" id="albumInfoModalLabel">Album Info</h5>
            <button
              <script type="module">
              import { showGalleryModal } from '../js/components/galleryModal.js';
              document.getElementById('openGroupGalleryModal').onclick = function() {
                showGalleryModal({
                  onSelect: url => {
                    document.getElementById('groupImage').value = url;
                  },
                  title: 'Select or Upload Group Image'
                });
              };
              document.getElementById('openEditGroupGalleryModal').onclick = function() {
                showGalleryModal({
                  onSelect: url => {
                    document.getElementById('editGroupImage').value = url;
                  },
                  title: 'Select or Upload Group Image'
                });
              };
              </script>
