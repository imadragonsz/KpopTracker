<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<!-- Shared Bootstrap Navbar for K-Pop Album Tracker -->
<nav class="navbar navbar-expand-lg navbar-custom fixed-top">
  <div class="container-fluid">
    <a
      class="navbar-brand d-flex align-items-center gap-2"
      href="/index.html"
      style="margin-bottom: 0"
      <img
        src="https://cdn-icons-png.flaticon.com/512/727/727245.png"
        alt="Logo"
        style="width: 32px; height: 32px"
      />
      K-Pop Tracker
    </a>
    <button
      class="navbar-toggler"
      type="button"
      data-bs-toggle="collapse"
      data-bs-target="#navbarNav"
      aria-controls="navbarNav"
      aria-expanded="false"
      aria-label="Toggle navigation"
    >
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-3 gap-2 flex-grow-1 align-items-center">
        <li class="nav-item">
          <a
            class="nav-link"
            href="../albumCollection.html"
            data-page="albumCollection.html"
            >Album Collection</a
          >
        </li>
        <li class="nav-item">
          <a
            class="nav-link"
            href="../groupManagement.html"
            data-page="groupManagement.html"
            >Group & Member Management</a
          >
        </li>
        <li class="nav-item">
          <a
            class="nav-link"
            href="../browse.html"
            data-page="browse.html"
            >Browse</a
          >
        </li>
      </ul>
      <div class="d-flex align-items-center">
        <button id="userMenuBtn" class="btn btn-outline-info btn-sm d-flex align-items-center" type="button">
          <span class="me-1"><i class="bi bi-person-circle" style="font-size:1.3em;"></i></span>
          <span id="userMenuBtnText">Account</span>
        </button>
        <span id="userEmail" class="text-light small ms-2"></span>
        <!-- User Modal -->
        <div class="modal fade" id="userMenuModal" tabindex="-1" aria-labelledby="userMenuModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark text-light">
              <div class="modal-header">
                <h5 class="modal-title" id="userMenuModalLabel">Account</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body" id="userMenuModalBody">
                <!-- Content will be injected by JS based on auth state -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</nav>
<script type="module">
  // User menu modal logic
  function renderUserMenuModal(isLoggedIn, email) {
    const body = document.getElementById('userMenuModalBody');
    if (!body) return;
    if (isLoggedIn) {
      body.innerHTML = `
        <div class="mb-3 text-center">
          <i class="bi bi-person-circle" style="font-size:2.5em;"></i>
          <div class="fw-bold mt-2">${email}</div>
        </div>
        <div class="d-grid gap-2">
          <a href="/pages/profile.html" class="btn btn-info">My Profile</a>
          <button id="logoutBtnModal" class="btn btn-outline-secondary">Logout</button>
        </div>
      `;
      // Always (re)attach logout handler after DOM update
      const logoutBtn = document.getElementById('logoutBtnModal');
      if (logoutBtn) {
        logoutBtn.onclick = async function() {
          try {
            if (window.signOut) {
              await window.signOut();
              // Hide the modal after logout
              const modalElem = document.getElementById('userMenuModal');
              if (modalElem && window.bootstrap) {
                const modalInstance = window.bootstrap.Modal.getOrCreateInstance(modalElem);
                modalInstance.hide();
              }
              // Remove any lingering Bootstrap modal backdrops
              document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
              document.body.classList.remove('modal-open');
              document.body.style.overflow = '';
              document.body.style.paddingRight = '';
              // Always refresh the page after logout to ensure all data is up to date
              window.location.reload();
            } else if (window.supabase) {
              await window.supabase.auth.signOut();
              window.location.reload();
            } else {
              window.location.reload();
            }
          } catch (err) {
            alert('Logout failed. Please try again.');
          }
        };
      }
    } else {
      body.innerHTML = `
        <div class="mb-3 text-center">
          <i class="bi bi-person-circle" style="font-size:2.5em;"></i>
        </div>
        <div class="d-grid gap-2">
          <button id="loginBtnModal" class="btn btn-info">Login</button>
        </div>
      `;
      // Always (re)attach login handler after DOM update
      const loginBtn = document.getElementById('loginBtnModal');
      if (loginBtn) {
        loginBtn.onclick = function() {
          if (typeof showLoginModal === 'function') {
            showLoginModal();
          } else {
            // fallback: try to trigger modal if available
            const modal = document.getElementById('authModal');
            if (modal && window.bootstrap) {
              const modalInstance = new window.bootstrap.Modal(modal);
              modalInstance.show();
            }
          }
        };
      }
    }
  }
  window.renderUserMenuModal = renderUserMenuModal;
  // Dynamically set user email in navbar if available
  (function setNavbarUserEmail() {
    const userEmailSpan = document.getElementById("userEmail");
    if (!userEmailSpan) return;
    let email = localStorage.getItem("user-email");
    function setOrHide(emailVal) {
      if (emailVal && emailVal !== "-") {
        userEmailSpan.textContent = emailVal;
        userEmailSpan.style.display = "";
      } else {
        userEmailSpan.style.display = "none";
      }
    }
    if ((!email || email === "-") && window.supabase && window.supabase.auth && typeof window.supabase.auth.getUser === 'function') {
      window.supabase.auth.getUser().then(({ data }) => {
        if (data && data.user && data.user.email) {
          setOrHide(data.user.email);
        } else {
          setOrHide("");
        }
      }).catch(() => setOrHide(""));
    } else {
      setOrHide(email);
    }
  })();
  // Highlight active nav link based on current page
  const navLinks = document.querySelectorAll(".nav-link[data-page]");
  navLinks.forEach((link) => {
    if (window.location.pathname.endsWith(link.getAttribute("data-page"))) {
      link.classList.add("active");
      link.setAttribute("aria-current", "page");
    } else {
      link.classList.remove("active");
      link.removeAttribute("aria-current");
    }
  });

  // Collapse navbar if width > 990px, only after Bootstrap is loaded
  function collapseNavbarOnDesktop() {
    const navbarCollapse = document.getElementById("navbarNav");
    const toggler = document.querySelector(".navbar-toggler");
    if (window.innerWidth > 990 && navbarCollapse) {
      // Always call collapse.hide() to sync Bootstrap's state
      if (window.bootstrap && window.bootstrap.Collapse) {
        const collapse =
          window.bootstrap.Collapse.getOrCreateInstance(navbarCollapse);
        collapse.hide();
      }
      // Fallback: forcibly remove 'show' class
      navbarCollapse.classList.remove("show");
      // Reset toggler aria-expanded
      if (toggler) {
        toggler.setAttribute("aria-expanded", "false");
        toggler.blur();
      }
    }
  }
  function setupCollapseListener() {
    if (window.bootstrap && window.bootstrap.Collapse) {
      window.addEventListener("resize", collapseNavbarOnDesktop);
      collapseNavbarOnDesktop();
    } else {
      setTimeout(setupCollapseListener, 100);
    }
  }
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", setupCollapseListener);
  } else {
    setupCollapseListener();
  }
</script>
<script>
// Ensure userMenuBtn event is always bound after DOM is ready (for dynamic navbar injection)
function setupUserMenuBtnListener() {
  var btn = document.getElementById('userMenuBtn');
  if (!btn) return;
  btn.addEventListener('click', async function() {
    console.log('userMenuBtn pressed');
    // Always update modal content to reflect latest auth state
    if (typeof window.updateAuthUI === 'function') {
      await window.updateAuthUI();
    }
    var ModalClass = window.bootstrap && window.bootstrap.Modal ? window.bootstrap.Modal : (window.Modal || null);
    if (!ModalClass) {
      console.warn('Bootstrap Modal not found.');
      return;
    }
    var modalElem = document.getElementById('userMenuModal');
    if (!modalElem) {
      console.warn('userMenuModal element not found.');
      return;
    }
    // Do NOT set modal content here; updateAuthUI already did it
    var modal = new ModalClass(modalElem);
    modal.show();
  });
}
// Always bind userMenuBtn after all HTML is loaded (for dynamic navbar injection)
setTimeout(setupUserMenuBtnListener, 0);
</script>
<script>
// Use event delegation to ensure loginBtn always works, even if dynamically rendered
document.addEventListener("click", function(e) {
  const btn = e.target.closest && e.target.closest("#loginBtn");
  if (btn) {
    console.log("loginBtn pressed");
    window.dispatchEvent(new CustomEvent("show-login-modal"));
  }
});
</script>
<script>
// Listen for the custom event and trigger the modal using authUI.js logic if available
window.addEventListener("show-login-modal", () => {
  try {
    if (typeof showLoginModal === "function") {
      showLoginModal();
    } else {
      // fallback: try to trigger modal if available
      const modal = document.getElementById("authModal");
      if (modal && window.bootstrap) {
        const modalInstance = new window.bootstrap.Modal(modal);
        modalInstance.show();
      } else {
        console.error("Login modal could not be shown: showLoginModal() missing and no #authModal found or Bootstrap not loaded.");
      }
    }
  } catch (err) {
    console.error("Error while trying to show login modal:", err);
  }
});
</script>
</script>
