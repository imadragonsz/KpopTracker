<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>K-Pop Album Collection</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
    <link rel="stylesheet" href="../styles/global.css" />
    <link rel="stylesheet" href="../styles/navbar.css" />
    <link rel="stylesheet" href="../styles/album-cards.css" />
    <link rel="stylesheet" href="../styles/modals.css" />
    <link rel="stylesheet" href="../styles/forms.css" />
    <link rel="stylesheet" href="../styles/loading.css" />
    <link rel="stylesheet" href="../styles/albumCollectionOverrides.css" />
    <link rel="stylesheet" href="../styles/albumCollectionRowOverrides.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <link rel="stylesheet" href="/styles/animations.css" />
    <link rel="stylesheet" href="../styles/flatpickr-dark.css" />
  </head>
  <body class="profile-bg">
  <div id="navbar-include"></div>
    <script>
      (async function loadNavbarAndScripts() {
        const navbarDiv = document.getElementById("navbar-include");
        if (navbarDiv.dataset.loaded) return;

        // Fetch and inject navbar HTML
        const html = await fetch("./components/navbar.html").then((res) =>
          res.text()
        );
        navbarDiv.innerHTML = html;
        navbarDiv.dataset.loaded = "true";
        // Dynamically load navbar.js after injection
        const script = document.createElement("script");
        script.type = "module";
        script.src = "../js/navbar.js";
        document.body.appendChild(script);
        // (Reverted) No manual toggler/collapse re-binding; use default Bootstrap behavior as before.

        // Load Supabase and Bootstrap if not already loaded
        const loadScript = (src, type = "text/javascript") =>
          new Promise((resolve, reject) => {
            if ([...document.scripts].some((s) => s.src.includes(src)))
              return resolve();
            const s = document.createElement("script");
            s.src = src;
            s.type = type;
            s.onload = resolve;
            s.onerror = reject;
            document.body.appendChild(s);
          });

        await loadScript(
          "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"
        );
        await loadScript(
          "https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        );

        // Load your app scripts (as modules if needed)
        const appScripts = [
          "../js/components/loading.js",
          "../js/authUI.js",
          "../js/api/supabaseClient.js",
          "../js/api/groupApi.js",
          "../js/api/albumApi.js",
        ];
        for (const src of appScripts) {
          await loadScript(src, "module");
        }

        // Admin-only: Hide albumForm if not admin (after navbar and scripts loaded)
        await loadScript("../js/components/adminCheck.js", "module");
        if (window.checkAdminStatus) {
          window.checkAdminStatus().then(isAdmin => {
            const form = document.getElementById("albumForm");
            if (form && !isAdmin) {
              form.style.display = "none";
              const warn = document.createElement("div");
              warn.className = "alert alert-warning mt-2";
              warn.textContent = "Only admins can add new albums.";
              form.parentNode.insertBefore(warn, form);
            }
          });
        }

        // Wait for updateAuthUIReady before running dependent code
        window.addEventListener(
          "updateAuthUIReady",
          () => {
            if (typeof window.updateAuthUI === "function")
              window.updateAuthUI();
          },
          { once: true }
        );
      })();
    </script>

    <section class="py-5 text-center hero-section">
      <div class="container">
        <img
          src="https://cdn-icons-png.flaticon.com/512/727/727245.png"
          alt="Vinyl Icon"
          style="
            width: 90px;
            height: 90px;
            background: #232a36;
            border-radius: 50%;
            padding: 10px;
            border: 2px solid #43c6ac;
          "
          class="mb-3 mt-2 shadow-none"
        />
        <h1 class="fw-bold mb-2 hero-heading-text text-center">
          Album Collection
        </h1>
        <p class="lead mb-3 hero-lead-text text-center">
          Add, edit, and browse your K-Pop albums. See your collection grow with
          every comeback!
        </p>
      </div>
    </section>

    <div
      class="container p-4 rounded shadow-lg main-container fade-in"
      style="max-width: 80%; background: #232946; width: 100%; margin-top: 20px"
    >
      <!-- Album Form -->
      <div class="row g-3 mb-4">
        <div class="col-12">
          <div class="card border-info bg-dark card-pop">
            <div class="card-body">
              <form id="albumForm" class="row g-2 align-items-end">
                <div class="col-12 col-md-4">
                  <select
                    id="groupSelect"
                    class="form-select"
                    required
                  ></select>
                </div>
                <div class="col-12 col-md-4">
                  <input
                    type="text"
                    id="album"
                    class="form-control"
                    placeholder="Album Name (e.g. MAP OF THE SOUL: 7)"
                    required
                  />
                </div>
                <div class="col-12 col-md-4">
                  <input
                    type="text"
                    class="form-control date-picker"
                    id="releaseDate"
                    placeholder="Release Date"
                    required
                    autocomplete="off"
                  />
                </div>
                <div class="col-12">
                  <div class="mb-2">
                    <button
                      type="button"
                      class="btn btn-outline-info btn-sm animated-btn"
                      id="openAlbumGalleryModal"
                    >
                      Choose or Upload Image
                    </button>
                  </div>
                  <input
                    type="file"
                    id="albumImageFile"
                    class="form-control mb-1"
                    accept="image/*"
                    style="display: none"
                  />
                  <input type="hidden" id="albumImage" />
                  <div
                    id="albumImageUploadStatus"
                    class="form-text text-info"
                  ></div>
                </div>
                <div class="col-12">
                  <label for="albumVersionInput" class="form-label"
                    >Album Versions</label
                  >
                  <div class="input-group mb-2 align-items-center">
                    <input
                      type="text"
                      id="albumVersionInput"
                      class="form-control"
                      placeholder="e.g. Photobook, Limited, Jewel Case"
                    />
                    <div class="input-group-text bg-dark border-0">
                      <input
                        type="checkbox"
                        id="albumVersionOnTheWay"
                        class="form-check-input mt-0"
                        title="Check if this version is on the way (pre-ordered or shipping)"
                      />
                      <label
                        for="albumVersionOnTheWay"
                        class="form-check-label ms-1 mb-0 text-warning"
                        style="font-size: 0.9em"
                        >On the Way</label
                      >
                    </div>
                    <button
                      type="button"
                      id="addAlbumVersionBtn"
                      class="btn btn-outline-info animated-btn"
                    >
                      Add
                    </button>
                  </div>
                  <div id="albumVersionsList" class="mb-2"></div>
                </div>
                <div class="col-12 d-grid mt-2">
                  <button type="submit" class="btn btn-info fw-bold">
                    Add Album
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- Filter Row -->
      <div class="row g-3 mb-3">
        <div class="col-12">
          <div
            class="album-filter-flex album-filter-row mb-3"
            style="overflow-x: auto"
          >
            <div class="col-auto" style="min-width: 180px; max-width: 220px">
              <input
                type="text"
                id="searchInput"
                class="form-control"
                placeholder="Search by album name..."
              />
            </div>
            <div class="col-auto" style="min-width: 110px; max-width: 180px">
              <select id="filterGroup" class="form-select">
                <option value="">All Groups</option>
              </select>
            </div>
            <div class="col-auto" style="min-width: 150px; max-width: 200px">
              <select id="filterReleaseDate" class="form-select">
                <option value="">All Dates</option>
              </select>
            </div>
            <div
              class="col-auto d-flex align-items-center gap-2"
              style="min-width: 180px; max-width: 220px"
            >
              <select
                id="sortAlbums"
                class="form-select"
                style="min-width: 120px"
              >
                <option value="group">Sort by Group</option>
                <option value="album">Sort by Album</option>
                <option value="releaseDate">Sort by Release Date</option>
              </select>
              <button
                id="reverseSortBtn"
                type="button"
                class="btn btn-outline-info px-2 py-1"
                title="Reverse sort order"
                style="font-size: 1.2em; line-height: 1"
              >
                <span
                  id="reverseSortIcon"
                  style="display: inline-block; transform: rotate(180deg)"
                  >&#8595;</span
                >
              </button>
            </div>
            <div
              class="col-auto d-flex justify-content-center align-items-center"
              style="min-width: 90px; height: 40px"
            >
              <span
                id="albumCount"
                class="fw-bold text-info text-center w-100 album-count-align"
              ></span>
            </div>
          </div>
        </div>
      </div>

      <!-- Album List -->
      <div class="row g-3 mb-0">
        <div class="col-12">
          <div
            class="card border-info bg-dark"
            style="border-radius: 18px; box-shadow: 0 2px 16px 0 #43c6ac33"
          >
            <div
              class="card-body p-3"
              style="padding-bottom: 0.5rem !important"
            >
              <ul
                id="album-list"
                class="list-group"
                style="
                  background: transparent;
                  border: none;
                  padding: 0;
                  margin: 0;
                "
              ></ul>
              <div id="albumPagination"></div>
              <template id="albumVersionsTemplate">
                <div class="mt-1">
                  <span class="fw-bold">Album Versions:</span>
                  <span class="album-versions-list"></span>
                </div>
              </template>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- end main-container -->

    <script type="module" src="../js/pages/albumCollectionPage.js"></script>

    <!-- Edit Album Modal -->
    <div
      class="modal fade"
      id="editAlbumModal"
      tabindex="-1"
      aria-labelledby="editAlbumModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
          <div class="modal-header">
            <h5 class="modal-title" id="editAlbumModalLabel">Edit Album</h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="editAlbumForm">
              <div class="mb-3">
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="editOnTheWay"
                  />
                  <label class="form-check-label" for="editOnTheWay"
                    >On the Way</label
                  >
                </div>
              </div>
              <div class="mb-3">
                <label for="editGroup" class="form-label">Group Name</label>
                <input
                  type="text"
                  class="form-control"
                  id="editGroup"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="editAlbum" class="form-label">Album Name</label>
                <input
                  type="text"
                  class="form-control"
                  id="editAlbum"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="editReleaseDate" class="form-label"
                  >Release Date</label
                >
                <input
                  type="text"
                  class="form-control date-picker"
                  id="editReleaseDate"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="editImage" class="form-label"
                  >Album Image URL</label
                >
                <div class="mb-2">
                  <button
                    type="button"
                    class="btn btn-outline-info btn-sm"
                    id="openEditAlbumGalleryModal"
                  >
                    Choose or Upload Image
                  </button>
                </div>
                <input
                  type="file"
                  class="form-control"
                  id="editImageFile"
                  accept="image/*"
                  style="display: none"
                />
                <input type="hidden" id="editImage" />
                <div
                  id="editImageUploadStatus"
                  class="form-text text-info"
                ></div>
                <script type="module">
                  import { showGalleryModal } from "../js/components/galleryModal.js";
                  document.getElementById("openAlbumGalleryModal").onclick =
                    function () {
                      const groupSelect =
                        document.getElementById("groupSelect");
                      const selectedGroup =
                        groupSelect && groupSelect.value
                          ? groupSelect.value
                          : null;
                      showGalleryModal({
                        onSelect: (url) => {
                          document.getElementById("albumImage").value = url;
                        },
                        title: "Select or Upload Album Image",
                        groupName: selectedGroup,
                      });
                    };
                  document.getElementById("openEditAlbumGalleryModal").onclick =
                    function () {
                      showGalleryModal({
                        onSelect: (url) => {
                          document.getElementById("editImage").value = url;
                        },
                        title: "Select or Upload Album Image",
                      });
                    };
                </script>
              </div>
              <div class="mb-3">
                <label class="form-label">Album Versions</label>
                <button
                  type="button"
                  class="btn btn-outline-info btn-sm ms-2"
                  data-bs-toggle="modal"
                  data-bs-target="#editVersionsModal"
                >
                  Edit Versions
                </button>
              </div>
              <button type="submit" class="btn btn-info fw-bold">
                Save Changes
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Versions Modal -->
    <div
      class="modal fade"
      id="editVersionsModal"
      tabindex="-1"
      aria-labelledby="editVersionsModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
          <div class="modal-header">
            <h5 class="modal-title" id="editVersionsModalLabel">
              Edit Album Versions
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="editVersionInput" class="form-label"
                >Version Name</label
              >
              <div class="input-group mb-2 align-items-center">
                <input
                  type="text"
                  id="editVersionInput"
                  class="form-control"
                  placeholder="e.g. Photobook, Limited, Jewel Case"
                />
                <div class="input-group-text bg-dark border-0">
                  <input
                    type="checkbox"
                    id="editVersionOnTheWay"
                    class="form-check-input mt-0"
                    title="Add the 'On the Way' tag to this version"
                  />
                  <label
                    for="editVersionOnTheWay"
                    class="form-check-label ms-1 mb-0"
                    style="font-size: 0.95em; color: #f8f9fa; font-weight: 500"
                    >On the Way</label
                  >
                </div>
                <button
                  type="button"
                  id="addEditVersionBtn"
                  class="btn btn-outline-info"
                >
                  Add
                </button>
              </div>
            </div>
            <div id="editVersionsList" class="mb-2"></div>
            <template id="editVersionItemTemplate">
              <span class="badge bg-info text-dark me-1 mb-1 d-inline-flex align-items-center justify-content-center">
                <span class="version-name"></span>
                <button type="button" class="btn btn-sm btn-danger btn-remove-version ms-2" title="Remove version" style="padding:0 6px 0 6px;line-height:1.1;font-size:0.95em;">
                  &times;
                </button>
              </span>
            </template>
          </div>
        </div>
      </div>
    </div>

    <!-- Album Info Modal -->
    <div
      class="modal fade"
      id="albumInfoModal"
      tabindex="-1"
      aria-labelledby="albumInfoModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
          <div class="modal-header">
            <h5 class="modal-title" id="albumInfoModalLabel">Album Info</h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body" id="albumInfoBody"></div>
        </div>
      </div>
    </div>

    <footer
      class="text-center py-4 mt-5"
      style="
        color: #bfc9db;
        background: #232226;
        border-radius: 0 0 18px 18px;
        box-shadow: 0 -2px 16px 0 #a06c8533;
      "
    >
      <div class="container">
        <small>
          K-Pop Album Tracker &copy; 2025. Made with
          <span style="color: #ff6f61">♥</span> for the K-Pop community. |
          <a href="#" style="color: #a06c85">Privacy Policy</a> |
          <a href="#" style="color: #a06c85">Terms</a>
        </small>
      </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module" src="../js/pages/albumCollectionPage.js"></script>
    <script>
      // Dynamically load userMenuModal.js after supabaseClient.js is ready
      (function loadUserMenuModalWhenReady() {
        function injectScript() {
          const script = document.createElement("script");
          script.type = "module";
          script.src = "../js/userMenuModal.js";
          document.body.appendChild(script);
        }
        if (window.supabasePromise) {
          injectScript();
        } else {
          let tries = 0;
          const maxTries = 20;
          const interval = setInterval(() => {
            if (window.supabasePromise) {
              clearInterval(interval);
              injectScript();
            } else if (++tries >= maxTries) {
              clearInterval(interval);
              console.error(
                "userMenuModal.js: supabasePromise not found after waiting."
              );
            }
          }, 100);
        }
      })();
    </script>

  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js"></script>
  <script src="../js/flatpickr-init.js"></script>
  </body>
</html>
