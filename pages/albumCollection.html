<!DOCTYPE html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>K-Pop Album Collection</title>
    
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  <link rel="stylesheet" href="../styles/global.css" />
  <link rel="stylesheet" href="../styles/navbar.css" />
  <link rel="stylesheet" href="../styles/album-cards.css" />
  <link rel="stylesheet" href="../styles/modals.css" />
  <link rel="stylesheet" href="../styles/forms.css" />
  <link rel="stylesheet" href="../styles/loading.css" />
  <link rel="stylesheet" href="../styles/albumCollectionOverrides.css" />
  </head>
  <body class="profile-bg">
  
    <div id="navbar-include"></div>
    <script>
      // Only load and inject the navbar if not already present
      if (!document.getElementById("navbar-include").dataset.loaded) {
        fetch("./components/navbar.html")
          .then((res) => res.text())
          .then((html) => {
            const navbarDiv = document.getElementById("navbar-include");
            navbarDiv.innerHTML = html;
            navbarDiv.dataset.loaded = "true";
            // Execute all scripts in the injected navbar
            const scripts = navbarDiv.querySelectorAll("script");
            scripts.forEach((oldScript) => {
              const newScript = document.createElement("script");
              if (oldScript.type) newScript.type = oldScript.type;
              if (oldScript.src) {
                newScript.src = oldScript.src;
              } else {
                newScript.textContent = oldScript.textContent;
              }
              document.body.appendChild(newScript);
            });
            setTimeout(() => {
              const toggler = document.querySelector(".navbar-toggler");
              const collapse = document.getElementById("navbarNav");
              if (window.bootstrap && toggler && collapse) {
                new window.bootstrap.Collapse(collapse, { toggle: false });
              }
            }, 0);
            if (!window._navbarScriptsLoaded) {
              window._navbarScriptsLoaded = true;
              const supabaseScript = document.createElement("script");
              supabaseScript.src =
                "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js";
              supabaseScript.onload = () => {
                const scripts = [
                '../js/components/loading.js',
                '../js/authUI.js',
                '../js/api/supabaseClient.js',
                '../js/api/groupApi.js',
                '../js/api/albumApi.js',
                '../js/pages/albumCollectionPage.js'
                ];
                scripts.forEach((src) => {
                  const s = document.createElement("script");
                  s.type = "module";
                  s.src = src;
                  document.body.appendChild(s);
                });
                // Wait for updateAuthUIReady before calling updateAuthUI or running dependent code
                window.addEventListener("updateAuthUIReady", () => {
                  function waitForRenderUserMenuModalAndUpdateAuthUI(tries = 0) {
                    if (typeof window.renderUserMenuModal === "function" && typeof window.updateAuthUI === "function") {
                      window.updateAuthUI();
                      // After all scripts, check for login modal flag
                      setTimeout(() => {
                        if (sessionStorage.getItem("showLoginOnGroupPage")) {
                          sessionStorage.removeItem("showLoginOnGroupPage");
                          setTimeout(() => {
                            const loginBtn = document.getElementById("loginBtn");
                            const logoutBtn = document.getElementById("logoutBtn");
                            if (
                              loginBtn &&
                              (!logoutBtn || logoutBtn.classList.contains("d-none"))
                            ) {
                              loginBtn.click();
                            }
                          }, 500);
                        }
                      }, 1000);
                    } else if (tries < 20) {
                      setTimeout(() => waitForRenderUserMenuModalAndUpdateAuthUI(tries + 1), 100);
                    } else {
                      console.warn("renderUserMenuModal or updateAuthUI not available after waiting");
                    }
                  }
                  waitForRenderUserMenuModalAndUpdateAuthUI();
                }, { once: true });
              };
              document.body.appendChild(supabaseScript);
            }
          });
      }
    </script>
    
  <section class="py-5 text-center hero-section">
      <div class="container">
        <img src="https://cdn-icons-png.flaticon.com/512/727/727245.png" alt="Vinyl Icon" style="width: 90px; height: 90px; background: #232a36; border-radius: 50%; padding: 10px; border: 2px solid #43c6ac;" class="mb-3 mt-2 shadow-none" />
        <h1 class="fw-bold mb-2 hero-heading-text text-center">Album Collection</h1>
        <p class="lead mb-3 hero-lead-text text-center">
          Add, edit, and browse your K-Pop albums. See your collection grow with every comeback!
        </p>
      </div>
    </section>
  <div class="container p-4 rounded shadow-lg main-container" style="max-width: 900px; background: #232946; width: 100%; margin-top: 20px;">
      <div class="row g-3 mb-4">
        <div class="col-12">
          <div class="card border-info bg-dark">
            <div class="card-body">
              <form id="albumForm" class="row g-2 align-items-end">
                <div class="col-12 col-md-4">
                  <select id="groupSelect" class="form-select" required></select>
                </div>
                <div class="col-12 col-md-4">
                  <input type="text" id="album" class="form-control" placeholder="Album Name (e.g. MAP OF THE SOUL: 7)" required />
                </div>
                <div class="col-12 col-md-4">
                  <select id="year" class="form-select" required></select>
                </div>
                <div class="col-12">
                  <div class="mb-2">
                    <button type="button" class="btn btn-outline-info btn-sm" id="openAlbumGalleryModal">Choose or Upload Image</button>
                  </div>
                  <input type="file" id="albumImageFile" class="form-control mb-1" accept="image/*" style="display:none;" />
                  <input type="hidden" id="albumImage" />
                  <div id="albumImageUploadStatus" class="form-text text-info"></div>
                </div>
                <div class="col-12">
                  <label for="albumVersionInput" class="form-label">Album Versions</label>
                  <div class="input-group mb-2 align-items-center">
                    <input type="text" id="albumVersionInput" class="form-control" placeholder="e.g. Photobook, Limited, Jewel Case" />
                    <div class="input-group-text bg-dark border-0">
                      <input type="checkbox" id="albumVersionOnTheWay" class="form-check-input mt-0" title="Check if this version is on the way (pre-ordered or shipping)" />
                      <label for="albumVersionOnTheWay" class="form-check-label ms-1 mb-0 text-warning" style="font-size:0.9em;">On the Way</label>
                    </div>
                    <button type="button" id="addAlbumVersionBtn" class="btn btn-outline-info">Add</button>
                  </div>
                  <div id="albumVersionsList" class="mb-2"></div>
                </div>
                <div class="col-12 d-grid mt-2">
                  <button type="submit" class="btn btn-info fw-bold">Add Album</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
      
      <div class="row g-2 mb-3 align-items-end flex-nowrap" style="overflow-x:auto;">
    <div class="row g-2 mb-3 align-items-end flex-nowrap album-filter-row" style="overflow-x:auto;">
        <div class="col-auto" style="min-width:180px;max-width:220px;">
          <input type="text" id="searchInput" class="form-control" placeholder="Search by album name..." />
        </div>
        <div class="col-auto" style="min-width:110px;max-width:180px;">
          <select id="filterGroup" class="form-select">
            <option value="">All Groups</option>
          </select>
        </div>
        <div class="col-auto" style="min-width:100px;max-width:120px;">
          <select id="filterYear" class="form-select">
            <option value="">All Years</option>
          </select>
        </div>
        <div class="col-auto d-flex align-items-center gap-2" style="min-width:180px;max-width:220px;">
          <select id="sortAlbums" class="form-select" style="min-width: 120px;">
            <option value="group">Sort by Group</option>
            <option value="album">Sort by Album</option>
            <option value="year">Sort by Year</option>
          </select>
          <button id="reverseSortBtn" type="button" class="btn btn-outline-info px-2 py-1" title="Reverse sort order" style="font-size:1.2em;line-height:1;">
            <span id="reverseSortIcon" style="display:inline-block;transform:rotate(180deg);">&#8595;</span>
          </button>
        </div>
        <div class="col-auto d-flex justify-content-center align-items-center" style="min-width:90px;height:40px;">
      <span id="albumCount" class="fw-bold text-info text-center w-100 album-count-align"></span>
        </div>
    </div>
    <link rel="stylesheet" href="../styles/albumCollectionRowOverrides.css" />
      </div>

      <div class="row g-3">
        <div class="col-12">
          <div class="card border-info bg-dark">
            <div class="card-body">
              <ul id="album-list" class="list-group"></ul>
              <template id="albumVersionsTemplate">
                <div class="mt-1">
                  <span class="fw-bold">Album Versions:</span>
                  <span class="album-versions-list"></span>
                </div>
              </template>

              
              <div class="modal fade" id="editAlbumModal" tabindex="-1" aria-labelledby="editAlbumModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                  <div class="modal-content bg-dark text-light">
                    <div class="modal-header">
                      <h5 class="modal-title" id="editAlbumModalLabel">Edit Album</h5>
                      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                      <form id="editAlbumForm">
                        <div class="mb-3">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="editOnTheWay" />
                            <label class="form-check-label" for="editOnTheWay">On the Way</label>
                          </div>
                        </div>
                        <div class="mb-3">
                          <label for="editGroup" class="form-label">Group Name</label>
                          <input type="text" class="form-control" id="editGroup" required />
                        </div>
                        <div class="mb-3">
                          <label for="editAlbum" class="form-label">Album Name</label>
                          <input type="text" class="form-control" id="editAlbum" required />
                        </div>
                        <div class="mb-3">
                          <label for="editYear" class="form-label">Year</label>
                          <input type="number" class="form-control" id="editYear" required />
                        </div>
                        <div class="mb-3">
                          <label for="editImage" class="form-label">Album Image URL</label>
                          <div class="mb-2">
                            <button type="button" class="btn btn-outline-info btn-sm" id="openEditAlbumGalleryModal">Choose or Upload Image</button>
                          </div>
                          <input type="file" class="form-control" id="editImageFile" accept="image/*" style="display:none;" />
                          <input type="hidden" id="editImage" />
                          <div id="editImageUploadStatus" class="form-text text-info"></div>
    <script type="module">
    import { showGalleryModal } from '../js/components/galleryModal.js';
    document.getElementById('openAlbumGalleryModal').onclick = function() {
      const groupSelect = document.getElementById('groupSelect');
      const selectedGroup = groupSelect && groupSelect.value ? groupSelect.value : null;
      showGalleryModal({
        onSelect: url => {
          document.getElementById('albumImage').value = url;
        },
        title: 'Select or Upload Album Image',
        groupName: selectedGroup
      });
    };
    document.getElementById('openEditAlbumGalleryModal').onclick = function() {
      showGalleryModal({
        onSelect: url => {
          document.getElementById('editImage').value = url;
        },
        title: 'Select or Upload Album Image'
      });
    };
    </script>
                        </div>

                        <div class="mb-3">
                          <label class="form-label">Album Versions</label>
                          <button type="button" class="btn btn-outline-info btn-sm ms-2" data-bs-toggle="modal" data-bs-target="#editVersionsModal">Edit Versions</button>
                        </div>
                        <button type="submit" class="btn btn-info fw-bold">Save Changes</button>
                      </form>
                    </div>
                  </div>
                </div>
              </div>


<div class="modal fade" id="editVersionsModal" tabindex="-1" aria-labelledby="editVersionsModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header">
        <h5 class="modal-title" id="editVersionsModalLabel">Edit Album Versions</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="editVersionInput" class="form-label">Version Name</label>
          <div class="input-group mb-2 align-items-center">
            <input type="text" id="editVersionInput" class="form-control" placeholder="e.g. Photobook, Limited, Jewel Case" />
            <div class="input-group-text bg-dark border-0">
              <input type="checkbox" id="editVersionOnTheWay" class="form-check-input mt-0" title="Add the 'On the Way' tag to this version" />
              <label for="editVersionOnTheWay" class="form-check-label ms-1 mb-0" style="font-size:0.95em; color:#f8f9fa; font-weight:500;">On the Way</label>
            </div>
            <button type="button" id="addEditVersionBtn" class="btn btn-outline-info">Add</button>
          </div>
        </div>
        <div id="editVersionsList" class="mb-2"></div>
      </div>
    </div>
  </div>
</div>
                      </form>
                    </div>
                  </div>
                </div>
              </div>
    
    <div
      class="modal fade"
      id="albumInfoModal"
      tabindex="-1"
      aria-labelledby="albumInfoModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
          <div class="modal-header">
            <h5 class="modal-title" id="albumInfoModalLabel">Album Info</h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body" id="albumInfoBody">
            
          </div>
        </div>
      </div>
    </div>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

</div>
<footer
  class="text-center py-4 mt-5"
  style="
    color: #bfc9db;
    background: #232226;
    border-radius: 0 0 18px 18px;
    box-shadow: 0 -2px 16px 0 #a06c8533;
  "
>
  <div class="container">
    <small>
      K-Pop Album Tracker &copy; 2025. Made with
      <span style="color: #ff6f61">♥</span> for the K-Pop community. |
      <a href="#" style="color: #a06c85">Privacy Policy</a> |
      <a href="#" style="color: #a06c85">Terms</a>
    </small>
  </div>
</footer>
<script>
// After navbar is injected, bind userMenuBtn logic
function setupUserMenuBtnListener() {
  var btn = document.getElementById('userMenuBtn');
  if (!btn) return;
  btn.addEventListener('click', function() {
    console.log('userMenuBtn pressed');
    var ModalClass = window.bootstrap && window.bootstrap.Modal ? window.bootstrap.Modal : (window.Modal || null);
    if (!ModalClass) {
      console.warn('Bootstrap Modal not found.');
      return;
    }
    var modalElem = document.getElementById('userMenuModal');
    if (!modalElem) {
      console.warn('userMenuModal element not found.');
      return;
    }
    function showModal(isLoggedIn, email) {
      var body = document.getElementById('userMenuModalBody');
      if (!body) return;
      if (isLoggedIn) {
        body.innerHTML = `
          <div class="mb-3 text-center">
            <i class="bi bi-person-circle" style="font-size:2.5em;"></i>
            <div class="fw-bold mt-2">${email}</div>
          </div>
          <div class="d-grid gap-2">
            <a href="/pages/profile.html" class="btn btn-info">My Profile</a>
            <button id="logoutBtnModal" class="btn btn-outline-secondary">Logout</button>
          </div>
        `;
        setTimeout(function() {
          var logoutBtn = document.getElementById('logoutBtnModal');
          if (logoutBtn) {
            logoutBtn.onclick = function() {
              if (window.signOut) {
                window.signOut();
              } else if (window.supabase) {
                window.supabase.auth.signOut().then(function() { window.location.reload(); });
              } else {
                window.location.reload();
              }
            };
          }
        }, 0);
      } else {
        body.innerHTML = `
          <div class="mb-3 text-center">
            <i class="bi bi-person-circle" style="font-size:2.5em;"></i>
          </div>
          <div class="d-grid gap-2">
            <button id="loginBtnModal" class="btn btn-info">Login</button>
          </div>
        `;
        setTimeout(function() {
          var loginBtn = document.getElementById('loginBtnModal');
          if (loginBtn) {
            loginBtn.onclick = function() {
              if (typeof showLoginModal === 'function') {
                showLoginModal();
              } else {
                var modal = document.getElementById('authModal');
                if (modal && window.bootstrap) {
                  var modalInstance = new window.bootstrap.Modal(modal);
                  modalInstance.show();
                }
              }
            };
          }
        }, 0);
      }
      var modal = new ModalClass(modalElem);
      modal.show();
    }
    // Always use Supabase as the source of truth for auth state
    if (window.supabase && window.supabase.auth && window.supabase.auth.getUser) {
      window.supabase.auth.getUser().then(function(resp) {
        var user = resp && resp.data && resp.data.user;
        if (user && user.email) {
          showModal(true, user.email);
        } else {
          showModal(false, '');
        }
      });
    } else {
      showModal(false, '');
    }
  });
}
// Wait for navbar to be injected, then bind
function tryBindUserMenuBtn(retries) {
  if (document.getElementById('userMenuBtn')) {
    setupUserMenuBtnListener();
  } else if (retries > 0) {
    setTimeout(function() { tryBindUserMenuBtn(retries - 1); }, 200);
  }
}
tryBindUserMenuBtn(20);
</script>
</body>
</html>
